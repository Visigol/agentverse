<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <title>Schedule Efficiency Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
  <style>
    :root {
      --background-main: #F0F8F5;
      --primary-accent: #00B14F;
      --card-background: #FFFFFF;
      --text-primary: #111827;
      --text-secondary: #6B7280;
      --border-light: #E5E7EB;
      --shadow-color: rgba(0, 0, 0, 0.05);
    }
    body {
      font-family: 'Inter', sans-serif;
      margin: 0;
      background-color: var(--background-main);
      color: var(--text-primary);
    }
    .container {
      padding: 30px;
      max-width: 1200px;
      margin: 0 auto;
    }
    .header {
      text-align: center;
      margin-bottom: 30px;
    }
    .header h1 {
      margin: 0;
      font-size: 2.2em;
      font-weight: 800;
    }
    .card {
      background-color: var(--card-background);
      border-radius: 12px;
      border: 1px solid var(--border-light);
      box-shadow: 0 4px 8px var(--shadow-color);
      padding: 25px;
      margin-bottom: 30px;
    }
    .controls {
      display: flex;
      align-items: center;
      gap: 15px;
      flex-wrap: wrap;
    }
    .control-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .controls label {
      font-weight: 600;
      color: var(--text-secondary);
    }
    .controls input[type="date"] {
      background-color: var(--background-main);
      border: 1px solid var(--border-light);
      border-radius: 8px;
      padding: 10px 12px;
      font-size: 1em;
    }
    .controls button {
      background-color: var(--primary-accent);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid var(--border-light);
    }
    th {
      background-color: #F9FAFB;
      font-weight: 600;
      color: var(--text-secondary);
    }
    .loader {
      border: 4px solid var(--border-light);
      border-top: 4px solid var(--primary-accent);
      border-radius: 50%;
      width: 22px;
      height: 22px;
      animation: spin 1s linear infinite;
      display: none;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .message-area {
        text-align: center;
        margin: 15px 0;
        min-height: 20px;
        font-weight: 600;
    }
    .error-message { color: #EF4444; }
    .success-message { color: var(--primary-accent); }

    .sticky-col {
      position: -webkit-sticky;
      position: sticky;
      left: 0;
      background-color: var(--card-background);
      z-index: 1;
    }
    #efficiencyTableHead .sticky-col {
      background-color: #F9FAFB;
    }
    .day-separator {
      border-right: 2px solid var(--border-light) !important;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Schedule Efficiency Dashboard</h1>
    </div>

    <div class="card">
      <div class="controls">
        <div class="control-group">
          <label for="startDate">Start Date:</label>
          <input type="date" id="startDate">
        </div>
        <div class="control-group">
          <label for="endDate">End Date:</label>
          <input type="date" id="endDate">
        </div>
        <button onclick="loadDashboardData()">Load Data</button>
        <div id="loader" class="loader"></div>
      </div>
       <div id="userMessage" class="message-area"></div>
    </div>

    <div class="card">
        <div class="control-group">
          <label for="daySelector">Displaying data for:</label>
          <select id="daySelector" onchange="renderChart()"></select>
        </div>
      <canvas id="efficiencyChart"></canvas>
    </div>

    <div class="card">
      <h2>Hourly Data Breakdown (by Day of Week)</h2>
      <div style="overflow-x: auto;">
        <table id="efficiencyTable">
            <thead id="efficiencyTableHead"></thead>
            <tbody id="efficiencyTableBody"></tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <h2>Suggestion Engine</h2>
      <p>Analyze the data from the selected period to generate a recommended staffing schedule for next week.</p>
      <button onclick="generateSchedule()">Generate Suggested Schedule</button>
      <div id="suggestionMessage" class="message-area"></div>

      <div id="suggestion-container" style="display: none; margin-top: 20px;">
        <h3>Recommended Staffing Levels</h3>
        <canvas id="suggestionChart"></canvas>
        <h3 style="margin-top: 20px;">Summary & Justification</h3>
        <div id="suggestionSummary"></div>
      </div>
    </div>
  </div>

  <script>
    let efficiencyChartInstance = null;
    let fullData = null;

    window.addEventListener('load', function() {
        const today = new Date();
        const aWeekAgo = new Date();
        aWeekAgo.setDate(today.getDate() - 7);
        document.getElementById('endDate').value = today.toISOString().split('T')[0];
        document.getElementById('startDate').value = aWeekAgo.toISOString().split('T')[0];
        document.getElementById('efficiencyTableBody').innerHTML = '<tr><td colspan="16" style="text-align:center; color: var(--text-secondary);">Select a date range and click "Load Data".</td></tr>';
    });

    function showLoader(show) {
      document.getElementById('loader').style.display = show ? 'inline-block' : 'none';
    }

    function setUserMessage(message, type, areaId = 'userMessage') {
        const msgEl = document.getElementById(areaId);
        msgEl.textContent = message;
        msgEl.className = 'message-area';
        if (type === "error") msgEl.classList.add('error-message');
        else if (type === "success") msgEl.classList.add('success-message');
    }

    function loadDashboardData() {
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      if (!startDate || !endDate) {
        setUserMessage("Please select both a start and end date.", "error");
        return;
      }
      showLoader(true);
      setUserMessage("", "status");
      document.getElementById('efficiencyTableBody').innerHTML = '<tr><td colspan="16" style="text-align:center;">Loading...</td></tr>';

      google.script.run
        .withSuccessHandler(data => {
          showLoader(false);
          fullData = data;
          populateDaySelector();
          renderChart();
          renderTable();
        })
        .withFailureHandler(err => {
          showLoader(false);
          setUserMessage(err.message, "error");
          document.getElementById('efficiencyTableBody').innerHTML = '<tr><td colspan="16" style="text-align:center; color:red;">Could not load data.</td></tr>';
        })
        .getScheduleEfficiencyData(startDate, endDate);
    }

    function populateDaySelector() {
        const selector = document.getElementById('daySelector');
        selector.innerHTML = '';
        const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
        days.forEach(day => {
            const option = document.createElement('option');
            option.value = day;
            option.textContent = day;
            selector.appendChild(option);
        });
    }

    function renderChart() {
        if (!fullData) return;
        const selectedDay = document.getElementById('daySelector').value;
        const data = fullData[selectedDay];

        const ctx = document.getElementById('efficiencyChart').getContext('2d');
        const labels = Object.keys(data).sort();
        const agentData = labels.map(hour => data[hour].avgAgents);
        const workloadData = labels.map(hour => data[hour].avgWorkload);

        if (efficiencyChartInstance) {
            efficiencyChartInstance.destroy();
        }

        efficiencyChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels.map(h => h + ':00'),
                datasets: [
                    {
                        label: 'Average Agents Working',
                        data: agentData,
                        backgroundColor: 'rgba(0, 177, 79, 0.6)'
                    },
                    {
                        label: 'Average Workload (Cases)',
                        data: workloadData,
                        backgroundColor: 'rgba(107, 114, 128, 0.6)'
                    }
                ]
            },
            options: {
                scales: { y: { beginAtZero: true, title: { display: true, text: 'Count' } } },
                plugins: { title: { display: true, text: `Hourly Staffing vs. Workload for ${selectedDay}`, font: { size: 18 } } }
            }
        });
    }

    function renderTable() {
        const tableHead = document.getElementById('efficiencyTableHead');
        const tableBody = document.getElementById('efficiencyTableBody');
        tableHead.innerHTML = '';
        tableBody.innerHTML = '';

        const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
        let headerHtml = '<tr><th class="sticky-col">Hour</th>';
        days.forEach(day => {
            headerHtml += `<th>Agents (${day.substring(0,3)})</th><th>Workload (${day.substring(0,3)})</th><th class="day-separator">Ratio (${day.substring(0,3)})</th>`;
        });
        headerHtml += '</tr>';
        tableHead.innerHTML = headerHtml;

        for (let hour = 7; hour < 20; hour++) {
            const hourKey = String(hour).padStart(2, '0');
            const row = tableBody.insertRow();
            row.insertCell().textContent = hourKey + ':00';
            row.cells[0].classList.add('sticky-col');

            days.forEach(day => {
                const dayData = fullData[day][hourKey];
                row.insertCell().textContent = dayData.avgAgents.toFixed(2);
                row.insertCell().textContent = dayData.avgWorkload.toFixed(2);
                const ratioCell = row.insertCell();
                ratioCell.textContent = dayData.casePerAgentRatio.toFixed(2);
                ratioCell.classList.add('day-separator');
            });
        }
    }
    let suggestionChartInstance = null;

    function generateSchedule() {
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        if (!startDate || !endDate) {
            setUserMessage("Please select a date range first.", "error", "suggestionMessage");
            return;
        }

        setUserMessage("Generating schedule...", "status", "suggestionMessage");
        document.getElementById('suggestion-container').style.display = 'none';

        google.script.run
            .withSuccessHandler(suggestions => {
                setUserMessage("Suggestions generated successfully.", "success", "suggestionMessage");
                document.getElementById('suggestion-container').style.display = 'block';
                renderSuggestionChart(suggestions);
                renderSuggestionSummary(suggestions);
            })
            .withFailureHandler(err => {
                setUserMessage(err.message, "error", "suggestionMessage");
            })
            .generateSuggestedSchedule(startDate, endDate);
    }

    function renderSuggestionChart(suggestions) {
        const ctx = document.getElementById('suggestionChart').getContext('2d');
        const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
        const hours = Object.keys(suggestions[days[0]]).sort();

        const datasets = days.map(day => {
            return {
                label: day,
                data: hours.map(hour => suggestions[day][hour].recommended),
                // Add styling for each day's line
            };
        });

        if (suggestionChartInstance) {
            suggestionChartInstance.destroy();
        }
        suggestionChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: hours.map(h => h + ':00'),
                datasets: datasets
            },
            options: {
                scales: { y: { beginAtZero: true, title: { display: true, text: 'Recommended Agents' } } }
            }
        });
    }

    function renderSuggestionSummary(suggestions) {
        const summaryDiv = document.getElementById('suggestionSummary');
        const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
        summaryDiv.innerHTML = '';
        let summaryHtml = '';
        const targetRatio = 2.0;

        days.forEach(day => {
            summaryHtml += `<h4>${day}</h4>`;
            let dailyJustifications = '';
            let busiestHour = { hour: null, workload: -1 };
            let totalWorkload = 0;
            let totalRecommendedStaff = 0;

            const hours = Object.keys(suggestions[day]).sort();
            hours.forEach(hour => {
                const data = suggestions[day][hour];
                const workload = fullData[day][hour].avgWorkload;
                totalWorkload += workload;
                totalRecommendedStaff += data.recommended;

                if (workload > busiestHour.workload) {
                    busiestHour = { hour, workload };
                }

                if (data.justification !== "No workload recorded for this hour on this day." && data.justification !== "Workload and staffing appear balanced.") {
                     dailyJustifications += `<li><strong>${hour}:00:</strong> ${data.justification} Recommending <strong>${data.recommended}</strong> agent(s).</li>`;
                }
            });

            if(dailyJustifications) {
                summaryHtml += `<ul>${dailyJustifications}</ul>`;
            }

            summaryHtml += `<div style="padding: 10px; background-color: #f9fafb; border-radius: 8px; margin-top: 10px;">`;
            summaryHtml += `<h5>${day} Summary</h5>`;
            if (totalWorkload > 0) {
                const avgWorkload = totalWorkload / hours.length;
                summaryHtml += `<p>The day's activity peaks around <strong>${busiestHour.hour}:00</strong>. The schedule aims to maintain a staffing level that keeps the case-per-agent ratio near our target of <strong>${targetRatio.toFixed(1)}</strong>. Based on an average workload of <strong>${avgWorkload.toFixed(1)}</strong> cases per hour, a total of <strong>${totalRecommendedStaff}</strong> agent-hours are recommended for the day.</p>`;
            } else {
                summaryHtml += `<p>No workload data was available for ${day}, so no staff are recommended.</p>`;
            }
            summaryHtml += `</div>`;
        });
        summaryDiv.innerHTML = summaryHtml;
    }
  </script>
</body>
</html>
