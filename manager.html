<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <title>Manager Dashboard - Agent Tracker</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    /* 1. Overall Theme & Color Palette */
    :root {
      --background-main: #F0F8F5; /* Very light, soft mint-green */
      --primary-accent: #00B14F; /* Vibrant, fresh green */
      --card-background: #FFFFFF; /* Clean white for cards */
      --text-primary: #111827; /* Dark charcoal/off-black */
      --text-secondary: #6B7280; /* Muted gray */
      --border-light: #E5E7EB; /* Very light gray for borders */
      --red-deny: #EF4444; /* A modern, clear red */
      --shadow-color: rgba(0, 0, 0, 0.05);
    }

    body {
      font-family: 'Inter', sans-serif;
      margin: 0;
      padding: 0;
      background-color: var(--background-main);
      color: var(--text-primary);
      font-size: 15px;
    }

    .manager-container {
      padding: 30px;
      max-width: 1200px;
      margin: 0 auto;
    }

    .header {
      background-color: var(--card-background);
      color: var(--text-primary);
      padding: 25px 30px;
      text-align: left;
      border-bottom: 1px solid var(--border-light);
      text-align: center;
      flex-grow: 1;
    }

    .header h1 {
      margin: 0;
      font-size: 2.2em;
      font-weight: 800;
      color: var(--text-primary); /* Dark text for header */
    }
    .header p {
      color: var(--text-secondary);
      margin: 5px 0 0 0;
    }

    h2 {
      font-size: 1.6em;
      font-weight: 700;
      color: var(--text-primary);
      margin-top: 40px;
      margin-bottom: 20px;
    }


    /* --- SIDEBAR STYLES --- */
    #sidebar-toggle-btn { position: fixed; top: 20px; left: 20px; z-index: 1001; background-color: var(--card-background); border: 1px solid var(--border-light); color: var(--text-primary); border-radius: 50%; width: 45px; height: 45px; padding: 0; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display:flex; align-items:center; justify-content:center; }
    #sidebar { position: fixed; top: 0; left: 0; width: 300px; height: 100%; background-color: #F9FAFB; z-index: 1000; transform: translateX(-100%); transition: transform 0.3s ease-in-out; display: flex; flex-direction: column; border-right: 1px solid var(--border-light); }
    #sidebar.open { transform: translateX(0); }
    .sidebar-header { display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 1px solid var(--border-light); }
    .sidebar-header h3 { margin: 0; font-size: 1.2em; color: var(--text-primary); font-weight:600; }
    .sidebar-close-btn { background: none; border: none; color: var(--text-secondary); font-size: 2em; line-height: 1; padding: 0; cursor: pointer; margin: 0; }
    #sidebar-content { padding: 10px; overflow-y: auto; flex-grow: 1; }
    .sidebar-category-header { color: var(--text-primary); font-weight: 600; margin-top: 20px; margin-bottom: 10px; padding-bottom: 5px; border-bottom: 1px solid var(--border-light); font-size: 0.9em; text-transform: uppercase; letter-spacing: 0.5px; cursor: pointer; position: relative; user-select: none; }
    .sidebar-category-header:first-of-type { margin-top: 0; }
    .sidebar-category-header::after { content: '▶'; position: absolute; right: 5px; font-size: 0.7em; transition: transform 0.2s ease-in-out; }
    .sidebar-category-header.expanded::after { transform: rotate(90deg); }
    .links-container { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-in-out; }
    .links-container.expanded { max-height: 500px; }
    .link-item { display: block; padding: 15px; border-radius: 8px; background-color: var(--card-background); margin-bottom: 10px; text-decoration: none; transition: background-color 0.2s ease; border: 1px solid var(--border-light); }
    .link-item:hover { background-color: var(--background-main); }
    .link-item-name { font-weight: 600; color: var(--primary-accent); font-size: 1.1em; margin: 0; }
    .link-item-desc { font-size: 0.9em; color: var(--text-secondary); margin-top: 5px; }

    /* Tab Navigation */
    .nav-tabs {
      background-color: var(--card-background);
      border-bottom: 1px solid var(--border-light);
      padding: 0 30px;
      display: flex;
      gap: 10px;
    }
    .nav-tabs button {
      background: none;
      border: none;
      color: var(--text-secondary);
      padding: 18px 25px;
      font-size: 1.1em;
      cursor: pointer;
      font-weight: 600;
      border-bottom: 3px solid transparent; /* Placeholder for active state */
      transition: color 0.2s, border-color 0.2s;
    }
    .nav-tabs button.active {
      color: var(--primary-accent);
      border-bottom-color: var(--primary-accent);
    }
    .nav-tabs button:not(.active):hover {
      color: var(--text-primary);
    }


    .top-section-wrapper {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 30px;
      gap: 30px;
      flex-wrap: wrap;
    }

    /* Controls Card */
    .controls {
      padding: 20px;
      background-color: var(--card-background);
      border: 1px solid var(--border-light);
      border-radius: 12px;
      display: flex;
      align-items: center;
      gap: 15px;
      flex-wrap: wrap;
      flex-grow: 1;
      min-width: 300px;
      box-shadow: 0 4px 8px var(--shadow-color);
    }
    .control-group { display: flex; align-items: center; gap: 8px; }
    .controls label { font-weight: 600; white-space: nowrap; color: var(--text-secondary); }
    .controls input[type="date"], .controls select {
      background-color: var(--background-main); color: var(--text-primary); border: 1px solid var(--border-light);
      border-radius: 8px; padding: 10px 12px; font-size: 1em;
    }
    .controls button {
      background-color: var(--primary-accent); color: white; cursor: pointer; transition: background-color 0.2s;
      border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600;
    }
    .controls button:hover { background-color: #008f3f; }
    .date-range-toggle { display: flex; align-items: center; gap: 5px; }

    /* Agent Status Cards Wrapper */
    .agent-cards-wrapper {
      display: flex;
      flex-direction: column;
      gap: 20px;
      flex: 0 0 300px; /* Fixed width for the column */
    }

    /* Common styles for agent boxes */
    .agent-box {
      background-color: var(--card-background);
      padding: 20px;
      border-radius: 12px;
      border: 1px solid var(--border-light);
      box-shadow: 0 4px 8px var(--shadow-color);
    }
    .agent-box h3 {
      margin-top: 0; margin-bottom: 15px; font-size: 1.2em; color: var(--text-primary);
      border-bottom: 1px solid var(--border-light); padding-bottom: 10px;
      display: flex; align-items: center; gap: 10px; font-weight: 700;
    }
    .agent-box h3.collapsible {
      cursor: pointer;
      user-select: none;
      position: relative;
    }
    .agent-box h3.collapsible::after {
      content: '▲';
      position: absolute;
      right: 5px;
      font-size: 0.8em;
      transition: transform 0.2s ease-in-out;
    }
    .agent-box h3.collapsible.collapsed::after {
      transform: rotate(180deg);
    }
    .agent-box ul {
      list-style-type: none; padding: 0; margin: 0;
      transition: max-height 0.3s ease-out, opacity 0.2s ease-out;
      overflow: hidden;
      max-height: 1000px; /* Large value for expanded state */
      opacity: 1;
    }
    .agent-box ul.collapsed {
      max-height: 0;
      opacity: 0;
      margin-top: 0;
      padding-top: 0;
      padding-bottom: 0;
    }

    #activeAgentsList {
      max-height: 200px;
      overflow-y: auto;
    }

    /* Table Styling */
    table {
      width: 100%; border-collapse: separate; border-spacing: 0;
      margin-top: 15px; background-color: var(--card-background);
      border-radius: 12px; overflow: hidden; border: 1px solid var(--border-light);
      font-size: 0.95em; box-shadow: 0 4px 8px var(--shadow-color);
    }
    th, td { border: none; padding: 12px 15px; text-align: left; vertical-align: middle; }
    th {
      background-color: var(--background-main); color: var(--text-primary); font-weight: 700;
      text-align: left; border-bottom: 1px solid var(--border-light);
    }
    td { border-bottom: 1px solid var(--border-light); }
    tbody tr:last-child td { border-bottom: none; }
    tbody tr:not(.details-row):hover { background-color: #F9FAFB; }

    .agent-name-cell { font-weight: 600; color: var(--text-primary); }

    .btn-view-cases, .btn-action {
      font-size: 0.9em;
      padding: 6px 14px;
      cursor: pointer;
      color: white;
      border: none;
      border-radius: 6px;
      transition: background-color 0.2s, transform 0.1s;
      font-weight: 600;
      min-width: 135px;
      justify-content: center;
      display: inline-flex;
      align-items: center;
    }

    .btn-view-cases { background-color: var(--text-secondary); }
    .btn-view-cases:hover { background-color: var(--text-primary); transform: translateY(-1px); }

    /* Approval Buttons */
    .btn-approve { background-color: var(--primary-accent); }
    .btn-approve:hover { background-color: #008f3f; }
    .btn-deny { background-color: var(--red-deny); }
    .btn-deny:hover { background-color: #d03c3c; }

    /* Details Row */
    .details-row > td {
      background-color: var(--background-main) !important; padding: 0 !important;
      border: 1px solid var(--primary-accent) !important;
    }
    .details-container { padding: 20px; }
    .details-container h4 { color: var(--text-primary); font-weight: 700; margin-top: 0; margin-bottom: 15px; }
    .details-container table { box-shadow: none; border: 1px solid var(--border-light); }
    .scrollable-table-container { max-height: 400px; overflow-y: auto; }
    .details-container th { background-color: #F9FAFB; }

    .loader {
      border: 4px solid var(--border-light); border-top: 4px solid var(--primary-accent);
      border-radius: 50%; width: 18px; height: 18px;
      animation: spin 0.8s linear infinite; display: none; margin: 0 0 0 10px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .message-area { text-align: center; margin: 15px 0; min-height: 20px; font-weight: 600; }
    .error-message { color: var(--red-deny); }
    .success-message { color: var(--primary-accent); }
    .status-message { color: var(--text-secondary); }

    #leaderboardBody > tr { cursor: pointer; }

    /* --- VERSION INFO CONTAINER --- */
    #version-info-container {
      text-align: right;
      font-size: 0.9em;
      color: var(--text-secondary);
    }
    #updateNotificationArea {
      margin-top: 5px;
      padding: 8px;
      background-color: var(--yellow);
      color: var(--text-primary);
      border-radius: 8px;
      border: 1px solid var(--border-light);
    }
    #updateNotificationArea button {
      width: 100%;
      padding: 6px;
      font-size: 0.9em;
      background-color: var(--text-primary);
      color: white;
      border: none;
      cursor: pointer;
      margin-top: 5px;
      border-radius: 6px;
    }

    /* --- NEW: Styles for Collapsible Sections --- */
    .collapsible-header {
      cursor: pointer;
      position: relative;
      user-select: none; /* Prevents text selection on click */
      padding-left: 25px; /* Make space for the arrow */
      /* Ensure it lines up with other h2 tags if they are not collapsible */
      margin-left: -25px;
    }
    .collapsible-header::before {
      content: '▶'; /* Collapsed state arrow */
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%) rotate(0deg);
      transition: transform 0.2s ease-in-out;
      font-size: 0.8em;
      color: var(--text-secondary);
    }
    .collapsible-header.expanded::before {
      transform: translateY(-50%) rotate(90deg); /* Expanded state arrow */
      color: var(--primary-accent);
    }
    .collapsible-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out;
    }
    .collapsible-content.expanded {
      /* A large value to accommodate any content size */
      max-height: 3000px;
      transition: max-height 0.5s ease-in;
    }
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; justify-content: center; align-items: center; }
    .modal-content { background-color: var(--card-background); border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); width: 90%; max-width: 1400px; max-height: 90vh; display: flex; overflow: hidden; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-light); padding: 20px; }
    .modal-header h2 { margin: 0; font-size: 1.5em; }
    .close-button { font-size: 2em; color: var(--text-secondary); background: none; border: none; cursor: pointer; }
    .modal-actions { display: flex; justify-content: flex-end; gap: 15px; padding: 20px; border-top: 1px solid var(--border-light); background-color: #F9FAFB; }

    /* --- MODAL STYLES (Copied from cases.html) --- */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; justify-content: center; align-items: center; }
    .modal-content { background-color: var(--card-background); border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); width: 90%; max-width: 1400px; max-height: 90vh; display: flex; overflow: hidden; }
    .modal-main { flex-grow: 1; padding: 30px; overflow-y: auto; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-light); padding-bottom: 20px; margin-bottom: 20px; }
    .modal-header h2 { margin: 0; font-size: 1.8em; }
    .close-button { font-size: 2.5em; font-weight: 300; color: var(--text-secondary); background: none; border: none; cursor: pointer; line-height: 1; }
    .details-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px 30px; }
    .details-grid .field { display: flex; flex-direction: column; }
    .details-grid .field strong { font-size: 0.8em; color: var(--text-secondary); margin-bottom: 3px; text-transform: uppercase; }
    .details-grid .field span { font-size: 1em; color: var(--text-primary); }
    .truncate-link { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 250px; display: inline-block; vertical-align: middle; color: #3B82F6; text-decoration: none; }
    .truncate-link:hover { text-decoration: underline; }
    .modal-actions { display: flex; justify-content: flex-end; gap: 20px; margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--border-light); }
    .log-section { margin-top: 25px; padding-top: 20px; border-top: 1px solid var(--border-light); }
    .log-section h3 { margin: 0 0 15px 0; font-size: 1.3em; color: var(--primary-accent); }
    .log-record { padding: 15px; border: 1px solid var(--border-light); border-radius: 8px; margin-bottom: 15px; background-color: #F9FAFB; }
    .log-record .details-grid { gap: 10px 25px; }
  </style>
</head>
<body>


<button id="sidebar-toggle-btn" onclick="toggleSidebar()">
  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
</button>
<div id="sidebar">
  <div class="sidebar-header">
    <h3>Important Links</h3>
    <button class="sidebar-close-btn" onclick="toggleSidebar()">×</button>
  </div>
  <div id="sidebar-content"></div>
</div>

  <div class="header">
    <h1>Manager Dashboard</h1>
    <p>Agent Productivity and Attendance Overview</p>
  </div>
<div id="version-info-container">
  <div>VERSION: <strong id="scriptVersionDisplay">...</strong></div>
  <div id="versionStatusMessage" style="font-size: 0.9em; margin-top: 3px;"></div>
  <div id="updateNotificationArea" style="display: none;">
      <strong>Update Available!</strong>
      <div id="updateFeaturesDisplay" style="font-size: 0.9em; margin: 4px 0;"></div>
      <button id="updateButton">Update Now</button>
  </div>
  <div id="versionError" class="error-message" style="display:none;"></div>
</div>
  <div class="nav-tabs">
    <button class="active" id="tab-homepage" onclick="showTab('homepage')">Homepage</button>
    <button onclick="window.open('<?= ScriptApp.getService().getUrl() ?>?page=production', '_blank')">Production</button>
    <button onclick="window.open('<?= ScriptApp.getService().getUrl() ?>?page=cases', '_blank')">Cases</button>
    <button id="tab-scheduling" onclick="showTab('scheduling')">Scheduling</button>
    <button id="tab-settings" onclick="showTab('settings')">Settings</button>
    <button id="tab-archive" onclick="showTab('archive')">Archive</button>
    <button onclick="window.open('<?= ScriptApp.getService().getUrl() ?>?page=query_engine', '_blank')">Query Engine</button>
  </div>

  <div id="archive-container" class="manager-container" style="display: none;">
    <div class="header" style="background-color: #fce8e6; border-bottom: 1px solid #f4c7c3;">
      <h1 style="color: #c0392b;">Archived Files</h1>
      <p style="color: #c0392b;">This is a read-only view of historical case data.</p>
    </div>
    <div class="controls" style="margin-top: 20px; flex-direction: column; align-items: stretch;">
        <div style="display: flex; flex-wrap: wrap; gap: 15px;">
            <input type="text" id="archive-case-id-filter" placeholder="Case ID..." >
            <select id="archive-status-filter"><option value="">All Statuses</option></select>
            <select id="archive-country-filter"><option value="">All Countries</option></select>
            <input type="text" id="archive-user-filter" placeholder="User Email...">
            <select id="archive-category-filter"><option value="">All Categories</option></select>
        </div>
        <div style="display: flex; flex-wrap: wrap; gap: 15px; margin-top: 10px;">
            <label for="archive-start-date">From:</label>
            <input type="date" id="archive-start-date">
            <label for="archive-end-date">To:</label>
            <input type="date" id="archive-end-date">
        </div>
        <div style="margin-top: 15px;">
            <button onclick="searchArchivedCases()">Search</button>
            <button onclick="exportArchiveToSheet()">Extract to Google Sheets</button>
            <div id="archive-loader" class="loader"></div>
        </div>
    </div>
    <div id="archive-message-area" class="message-area"></div>
    <div id="archive-table-container">
        <!-- The table of archived cases will be rendered here by JavaScript -->
    </div>
    <div id="archive-pagination-container" class="pagination-controls" style="margin-top: 20px; text-align: center;">
        <!-- Pagination buttons will be rendered here -->
    </div>

    <!-- MODAL FOR ARCHIVE (Copied from cases.html) -->
    <div id="case-modal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-main">
          <div class="modal-header">
              <h2 id="modal-title">Case Details</h2>
              <button class="close-button" onclick="closeCaseModal()">×</button>
          </div>
          <div class="details-grid" id="modal-details-grid"></div>
          <div id="escalation-logs-container" class="log-section" style="display:none;">
              <h3>Escalation Logs</h3>
              <div id="escalation-logs-grid"></div>
          </div>
          <div id="pausing-logs-container" class="log-section" style="display:none;">
              <h3>Pausing Logs</h3>
              <div id="pausing-logs-grid"></div>
          </div>
          <div id="cooperation-logs-container" class="log-section" style="display:none;">
              <h3>Cooperation Logs</h3>
              <div id="cooperation-logs-grid"></div>
          </div>
          <div class="modal-actions">
            <!-- Actions will be hidden for the read-only archive view -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="scheduling-container" class="manager-container" style="display: none;">
    <h2>Scheduling Tools</h2>
    <div class="card">
        <h3>Efficiency Dashboard</h3>
        <p>Analyze historical staffing and workload data to identify scheduling inefficiencies.</p>
        <button class="btn-view-cases" onclick="window.open('<?= ScriptApp.getService().getUrl() ?>?page=schedule-dashboard', '_blank')">Open Dashboard</button>
    </div>
     <div class="card" style="margin-top: 20px;">
        <h3>Review Next Week's Schedule</h3>
        <p>Review agent applications for next week against the system's recommended staffing levels.</p>
        <button class="btn-view-cases" onclick="window.open('<?= ScriptApp.getService().getUrl() ?>?page=manager-review', '_blank')">Open Review Calendar</button>
    </div>
  </div>

  <div id="homepage-container" class="manager-container">
    <div class="top-section-wrapper">
      <div class="controls">
        <div class="control-group">
          <label for="startDate">Start:</label>
          <input type="date" id="startDate">
        </div>
        <div class="control-group">
          <label for="endDate">End:</label>
          <input type="date" id="endDate">
        </div>
        <div class="date-range-toggle">
          <input type="checkbox" id="dateRangeToggle" onchange="toggleDateRange()">
          <label for="dateRangeToggle">Use Range</label>
        </div>
        <button onclick="loadManagerData()">Load Data</button>
        <div id="loader" class="loader"></div>
      </div>
      <div class="agent-cards-wrapper">
        <div class="agent-box" id="activeAgentsBox">
          <h3>
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
            Active Agents <span id="activeAgentsCount"></span>
          </h3>
          <ul id="activeAgentsList">
            <li style="color:var(--text-secondary); font-style:italic;">Loading...</li>
          </ul>
        </div>
        <div class="agent-box" id="inactiveAgentsBox">
          <h3 class="collapsible" onclick="toggleInactiveAgentsList()">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><line x1="19" y1="8" x2="19" y2="8"></line><line x1="19" y1="14" x2="19" y2="14"></line></svg>
            Inactive Agents <span id="inactiveAgentsCount"></span>
          </h3>
          <ul id="inactiveAgentsList" class="collapsed">
            <li style="color:var(--text-secondary); font-style:italic;">Loading...</li>
          </ul>
        </div>
      </div>
    </div>

    <div id="userMessage" class="message-area"></div>

    <h2 class="collapsible-header">Agent Summary <span id="summaryDateDisplay" style="font-size:0.7em; font-weight: 400; color:var(--text-secondary);"></span></h2>
    <div class="collapsible-content">
      <table id="agentSummaryTable">
        <thead>
          <tr>
            <th>Agent Name</th>
            <th>Total Work Time</th>
            <th>Total Break Time</th>
            <th>Total Meeting Time</th>
            <th>Cases Handled</th>
          </tr>
        </thead>
        <tbody id="agentSummaryBody"></tbody>
      </table>
    </div>

    <div class="approval-section">
      <h2 class="collapsible-header">Attendance Correction Requests</h2>
      <div class="collapsible-content">
        <div id="approvalMessage" class="message-area"></div>
        <table id="approvalRequestsTable">
          <thead>
            <tr>
              <th>Agent</th>
              <th>Original Timestamp</th>
              <th>Original Action</th>
              <th>Session ID</th>
              <th>Requested Timestamp</th>
              <th>Reason</th>
              <th style="text-align: right;">Actions</th>
            </tr>
          </thead>
          <tbody id="approvalRequestsBody"></tbody>
        </table>
      </div>
    </div>

    <div class="leaderboard-section">
      <h2 class="collapsible-header">Agent Leaderboard</h2>
      <div class="collapsible-content">
        <table id="leaderboardTable">
          <thead>
            <tr>
              <th>Rank</th>
              <th>Agent Name</th>
              <th>Total Cases Completed</th>
              <th>Average Handling Time</th>
            </tr>
          </thead>
          <tbody id="leaderboardBody"></tbody>
        </table>
      </div>
    </div>

    <div class="leaderboard-section">
      <h2 class="collapsible-header">Agent Attendance Log</h2>
      <div class="collapsible-content">
        <div class="controls">
          <div class="control-group">
            <label for="agentLogSelector">Select Agent:</label>
            <select id="agentLogSelector"></select>
          </div>
          <div class="control-group">
            <label for="logDateFrom">From:</label>
            <input type="date" id="logDateFrom">
          </div>
          <div class="control-group">
            <label for="logDateTo">To:</label>
            <input type="date" id="logDateTo">
          </div>
          <button onclick="loadManagerAgentLog()">View Log</button>
          <div id="attendanceLogLoaderManager" class="loader"></div>
        </div>
        <div id="attendanceLogMessageManager" class="message-area" style="margin-top:0;"></div>
        <table id="attendanceLogTable">
          <thead>
            <tr>
              <th>Timestamp</th>
              <th>Action</th>
              <th>Session ID</th>
            </tr>
          </thead>
          <tbody id="managerLogTableBody"></tbody>
        </table>
      </div>
    </div>

    <!-- Anomaly Detection Section -->
    <div class="anomalies-section">
      <h2 class="collapsible-header">Anomaly Detection</h2>
      <div class="collapsible-content">
        <div class="controls">
          <div class="control-group">
            <label for="anomalyStartDate">Start Date:</label>
            <input type="date" id="anomalyStartDate">
          </div>
          <div class="control-group">
            <label for="anomalyEndDate">End Date:</label>
            <input type="date" id="anomalyEndDate">
          </div>
          <button onclick="loadAnomalies()">Load Anomalies</button>
          <div id="anomalyLoader" class="loader"></div>
        </div>
        <div id="anomalyMessage" class="message-area"></div>
        <table id="anomalyTable">
          <thead>
            <tr>
              <th>Case ID</th>
              <th>Anomaly Type</th>
              <th>Details</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="anomalyBody"></tbody>
        </table>
      </div>
    </div>

    <div id="fix-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 900px; flex-direction: column;">
            <div class="modal-header">
                <h2>Fix Calculation for Case ID: <strong id="fix-case-id"></strong></h2>
                <button class="close-button" onclick="closeFixModal()">×</button>
            </div>
            <div class="modal-body" style="padding: 20px; max-height: 70vh; overflow-y: auto;">
                <h4>Calculation Preview</h4>
                <table class="simple-table" style="width:100%;">
                    <thead><tr><th>Metric</th><th>Current Value</th><th>Proposed Value</th></tr></thead>
                    <tbody>
                        <tr><td>Agent Handling Time</td><td id="current-aht"></td><td id="proposed-aht"></td></tr>
                        <tr><td>Pause Duration</td><td id="current-pause"></td><td id="proposed-pause"></td></tr>
                        <tr><td>Escalation Duration</td><td id="current-escalation"></td><td id="proposed-escalation"></td></tr>
                    </tbody>
                </table>

                <h4 style="margin-top: 20px;">Problematic Logs</h4>
                <p style="font-size: 0.9em; color: var(--text-secondary);">The following log entries have been identified as overlapping or duplicated. Select the entries you wish to delete.</p>
                <div id="problematic-logs-container"></div>
            </div>
            <div class="modal-actions" style="margin-top: 20px; justify-content: space-between;">
                <div>
                    <button class="btn-deny" id="delete-logs-btn" onclick="deleteSelectedLogs()">Delete Selected Logs</button>
                </div>
                <div>
                    <button class="btn-secondary" onclick="closeFixModal()">Cancel</button>
                    <button class="btn-primary" id="confirm-fix-btn" onclick="applyFix()">Confirm & Save All Changes</button>
                </div>
            </div>
        </div>
    </div>
  </div>

  <div id="settings-container" class="manager-container" style="display: none;">
    <h2>Settings</h2>
    <div class="collapsible-content expanded">
        <h3>Manage User Access for 'Cases' Tab</h3>
        <div class="controls">
            <div class="control-group">
                <label for="newUserEmail">Agent Email:</label>
                <input type="email" id="newUserEmail" placeholder="agent.email@example.com" style="width: 250px;">
            </div>
            <button onclick="addUserAccess()">Add User</button>
            <div id="addUserLoader" class="loader"></div>
        </div>
        <div id="userAccessMessage" class="message-area"></div>

        <h4>Authorized Users</h4>
        <div style="max-height: 300px; overflow-y: auto;">
            <table id="authorizedUsersTable">
                <thead>
                    <tr>
                        <th>Agent Email</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="authorizedUsersBody">
                    <tr><td colspan="2" style="text-align:center;">Loading...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
  </div>

<script>
    // --- Mock google.script.run for local testing ---
    if (typeof google === 'undefined') {
      window.google = {
        script: {
          run: {
            withSuccessHandler: function(handler) {
              return this;
            },
            withFailureHandler: function(handler) {
              return this;
            },
            getArchivedCases: function(options) {
              // Simulate a successful response with empty data
              if (this.withSuccessHandler) {
                this.withSuccessHandler({ records: [], total: 0 });
              }
            }
          }
        }
      };
    }
    // --- UTILITY AND HELPER FUNCTIONS ---
    let currentArchivedPage = 1;
    let totalArchivedRecords = 0;
    const ARCHIVE_ITEMS_PER_PAGE = 20;
    let archivedCasesStore = {}; // To store full case data for the modal
    let activeCaseData = null; // To store data for the open modal
    const ALL_FIELDS = ['Created By', 'Useremail', 'Main Task ID', 'Country', 'Menu Request Sent Date', 'Language', 'Case Title', 'Category', 'Account Name', 'Status', 'Provider Id', 'City', 'Menu instructions', 'Onboarding instructions', 'Menu Comment', 'Menu link', 'Dish Photos Link', 'Photo Coverage', 'Main Task Start Date/Time', 'Main Task End Date/Time', 'Task TAT', 'Escalated Comment', 'Task Paused', 'TAT Adherance', 'Salesforce Updated', 'Salesforce Updated time', 'Ready for QA', 'Date stamp', 'Task Type', 'Rework Count', 'No of Main dishes(Excluding Extras, drinks, sides etc.)', 'Total No. of dishes', 'Total No. of categories', 'Total no. of options', 'Total no. of option Groups', 'Total no. of tags', 'Total no. of timetables.', 'No of Valid Photos for Main dishes (Exlcuding Extras, drinks, sides etc.)', 'Comments', 'Event Summary', 'Stored Escalation Duration', 'Stored Pause Duration', 'Stored Agent Handling Time', 'Retailer Provider Type', 'Airtable Link', 'Description Coverage', 'Visual and Descriptive Elements', 'Claim Flag', 'SLA Missed Reason', 'SLA Missed Comment', 'Linking Snapshot URL'];


    function showTab(tabName) {
      document.getElementById('homepage-container').style.display = tabName === 'homepage' ? 'block' : 'none';
      document.getElementById('settings-container').style.display = tabName === 'settings' ? 'block' : 'none';
      document.getElementById('scheduling-container').style.display = tabName === 'scheduling' ? 'block' : 'none';
      document.getElementById('archive-container').style.display = tabName === 'archive' ? 'block' : 'none';
      document.querySelectorAll('.nav-tabs button').forEach(button => button.classList.remove('active'));
      document.getElementById(`tab-${tabName}`).classList.add('active');
      if (tabName === 'settings') {
        loadAuthorizedUsers();
      }
      if (tabName === 'archive') {
        loadArchivedCases(1);
        loadArchiveFilters();
      }
    }

    function loadArchiveFilters() {
      google.script.run
        .withSuccessHandler(options => {
          const statusFilter = document.getElementById('archive-status-filter');
          const countryFilter = document.getElementById('archive-country-filter');
          const categoryFilter = document.getElementById('archive-category-filter');

          // Populate Status
          options.statuses.forEach(status => {
            const option = document.createElement('option');
            option.value = status;
            option.textContent = status;
            statusFilter.appendChild(option);
          });

          // Populate Country
          options.countries.forEach(country => {
            const option = document.createElement('option');
            option.value = country;
            option.textContent = country;
            countryFilter.appendChild(option);
          });

          // Populate Category
          options.categories.forEach(category => {
            const option = document.createElement('option');
            option.value = category;
            option.textContent = category;
            categoryFilter.appendChild(option);
          });
        })
        .withFailureHandler(err => {
          console.error("Failed to load archive filters:", err);
        })
        .getArchiveFilterOptions();
    }

    function searchArchivedCases() {
        currentArchivedPage = 1;
        loadArchivedCases(1);
    }

    function loadArchivedCases(page = 1) {
        currentArchivedPage = page;
        const offset = (page - 1) * ARCHIVE_ITEMS_PER_PAGE;

        // Collect values from all filter fields
        const filters = {
            limit: ARCHIVE_ITEMS_PER_PAGE,
            offset: offset,
            caseId: document.getElementById('archive-case-id-filter').value,
            status: document.getElementById('archive-status-filter').value,
            startDate: document.getElementById('archive-start-date').value,
            endDate: document.getElementById('archive-end-date').value,
            country: document.getElementById('archive-country-filter').value,
            userEmail: document.getElementById('archive-user-filter').value,
            category: document.getElementById('archive-category-filter').value
        };

        showLoader(true, 'archive-loader');
        google.script.run
            .withSuccessHandler(displayArchivedCases)
            .withFailureHandler(err => {
                showLoader(false, 'archive-loader');
                setUserMessage(err.message, "error", "archive-message-area");
            })
            .getArchivedCases(filters);
    }

    function displayArchivedCases(response) {
      showLoader(false, 'archive-loader');
      const container = document.getElementById('archive-table-container');
      const cases = response.records;
      totalArchivedRecords = response.total;

      // Store the detailed records for modal use
      archivedCasesStore = {};
      if (cases && cases.length > 0) {
        cases.forEach(caseData => {
            // The backend already aggregates escalations/pauses into the record
            archivedCasesStore[caseData['Main Task ID']] = caseData;
        });
      }

      if (!cases || cases.length === 0) {
        container.innerHTML = '<p>No archived cases found for the current filter.</p>';
        renderArchivePagination();
        return;
      }

      let tableHtml = '<table><thead><tr><th>Main Task ID</th><th>Country</th><th>Account Name</th><th>Status</th><th>End Date</th></tr></thead><tbody>';
      cases.forEach(caseData => {
        // Updated onclick to use the new modal function with just the ID
        tableHtml += `<tr onclick="openArchiveCaseModal('${caseData['Main Task ID']}')" style="cursor:pointer;">
          <td>${caseData['Main Task ID'] || ''}</td>
          <td>${caseData['Country'] || ''}</td>
          <td>${caseData['Account Name'] || ''}</td>
          <td>${caseData['Status'] || ''}</td>
          <td>${caseData['Main Task End Date/Time'] ? formatDisplayDate(caseData['Main Task End Date/Time']) : ''}</td>
        </tr>`;
      });
      tableHtml += '</tbody></table>';
      container.innerHTML = tableHtml;
      renderArchivePagination();
    }

    function renderArchivePagination() {
        const paginationContainer = document.getElementById('archive-pagination-container');
        paginationContainer.innerHTML = '';
        const totalPages = Math.ceil(totalArchivedRecords / ARCHIVE_ITEMS_PER_PAGE);

        if (totalPages <= 1) return;

        const prevButton = document.createElement('button');
        prevButton.textContent = '« Previous';
        prevButton.disabled = currentArchivedPage === 1;
        prevButton.onclick = () => loadArchivedCases(currentArchivedPage - 1);
        paginationContainer.appendChild(prevButton);

        const pageInfo = document.createElement('span');
        pageInfo.textContent = ` Page ${currentArchivedPage} of ${totalPages} `;
        pageInfo.style.margin = "0 10px";
        paginationContainer.appendChild(pageInfo);

        const nextButton = document.createElement('button');
        nextButton.textContent = 'Next »';
        nextButton.disabled = currentArchivedPage === totalPages;
        nextButton.onclick = () => loadArchivedCases(currentArchivedPage + 1);
        paginationContainer.appendChild(nextButton);
    }

    // --- NEW MODAL LOGIC (ADAPTED FROM CASES.HTML) ---
    function openArchiveCaseModal(caseId) {
      const caseDetails = archivedCasesStore[caseId];
      if (!caseDetails) {
        alert("Could not find details for case " + caseId);
        return;
      }
      renderModalContent(caseDetails);
      document.getElementById('case-modal').style.display = 'flex';
    }

    function closeCaseModal() {
      document.getElementById('case-modal').style.display = 'none';
      activeCaseData = null;
    }

    function renderModalContent(caseDetails) {
        activeCaseData = caseDetails;
        const grid = document.getElementById('modal-details-grid');
        document.getElementById('modal-title').textContent = `Archived Case: ${activeCaseData['Main Task ID']}`;

        let detailsHTML = '';
        const linkFields = ['Menu link', 'Dish Photos Link', 'Airtable Link', 'Linking Snapshot URL'];
        ALL_FIELDS.forEach(field => {
            // Use a renamed property from the backend if it exists (e.g., pauses instead of pausingLogs)
            let displayValue = activeCaseData[field] || '';
            let finalHtml;

            if (linkFields.includes(field) && displayValue) {
                finalHtml = `<a href="${displayValue}" target="_blank" class="truncate-link">${displayValue}</a>`;
            } else if (displayValue) {
                if (isDateTimeField(field)) displayValue = formatDisplayDate(displayValue);
                else if (isDurationField(field)) displayValue = formatTime(displayValue);
                finalHtml = `<span>${displayValue}</span>`;
            } else {
                finalHtml = `<span></span>`;
            }
            detailsHTML += `<div class="field"><strong>${field}</strong>${finalHtml}</div>`;
        });
        grid.innerHTML = detailsHTML;

        // The CSV data uses 'pauses', 'escalations', 'cooperations'
        displayCaseLogs({
            pausingLogs: caseDetails.pauses,
            escalationLogs: caseDetails.escalations,
            cooperationLogs: caseDetails.cooperations
        });

        // Hide action buttons for read-only view
        document.querySelector('#case-modal .modal-actions').style.display = 'none';
    }

    function displayCaseLogs(logs) {
        const renderLogSection = (containerId, gridId, logArray, title) => {
            const container = document.getElementById(containerId);
            const grid = document.getElementById(gridId);
            if (logArray && logArray.length > 0) {
                let allLogsHtml = '';
                logArray.forEach(log => {
                    allLogsHtml += `<div class="log-record"><div class="details-grid">`;
                    for (const header in log) {
                        let displayValue = log[header] || '';
                        if (displayValue) { // Only show fields that have a value
                            if (isDateTimeField(header) && displayValue) displayValue = formatDisplayDate(displayValue);
                            allLogsHtml += `<div class="field"><strong>${header}</strong><span>${displayValue}</span></div>`;
                        }
                    }
                    allLogsHtml += `</div></div>`;
                });
                grid.innerHTML = allLogsHtml;
                container.style.display = 'block';
            } else {
                container.style.display = 'none';
            }
        };

        renderLogSection('escalation-logs-container', 'escalation-logs-grid', logs.escalationLogs, 'Escalation Logs');
        renderLogSection('pausing-logs-container', 'pausing-logs-grid', logs.pausingLogs, 'Pausing Logs');
        renderLogSection('cooperation-logs-container', 'cooperation-logs-grid', logs.cooperationLogs, 'Cooperation Logs');
    }

    // --- HELPER FUNCTIONS (COPIED FROM CASES.HTML) ---
    function isDateTimeField(fieldName) {
        const lower = (fieldName || '').toLowerCase();
        return (lower.includes('date') || lower.includes('time')) && !isDurationField(fieldName);
    }

    function isDurationField(fieldName) {
        const lower = (fieldName || '').toLowerCase();
        return lower.includes('duration') || lower.includes('agent handling time');
    }

    function formatDisplayDate(isoString) {
        if (!isoString) return '';
        try {
            const date = new Date(isoString);
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const year = date.getFullYear();
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            return `${month}-${day}-${year} ${hours}:${minutes}:${seconds}`;
        } catch (e) {
            return isoString;
        }
    }
     function formatTime(s) { // Renamed from formatDuration to avoid conflict
        if (isNaN(s) || !isFinite(s)) s = 0;
        const prefix = s < 0 ? "-" : "";
        s = Math.abs(s);
        const hours = Math.floor(s / 3600);
        const minutes = Math.floor((s % 3600) / 60);
        const seconds = Math.floor(s % 60);
        return `${prefix}${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    }


    function toggleDateRange() {
      const endDateInput = document.getElementById('endDate');
      const isRange = document.getElementById('dateRangeToggle').checked;
      endDateInput.disabled = !isRange;
      if (!isRange) { endDateInput.value = document.getElementById('startDate').value; }
    }

    function exportArchiveToSheet() {
      showLoader(true, 'archive-loader');
      setUserMessage("Starting export... Please wait.", "status", "archive-message-area");
      google.script.run
        .withSuccessHandler(url => {
          showLoader(false, 'archive-loader');
          setUserMessage("Export started! The sheet will be populated in the background. You can open it now.", "success", "archive-message-area");
          window.open(url, '_blank');
        })
        .withFailureHandler(err => {
          showLoader(false, 'archive-loader');
          setUserMessage(err.message, "error", "archive-message-area");
        })
        .startArchiveExport();
    }

    function showLoader(show, id = 'loader') { document.getElementById(id).style.display = show ? 'inline-block' : 'none'; }
    function setUserMessage(message, type = "status", areaId = 'userMessage') {
      const msgEl = document.getElementById(areaId);
      msgEl.textContent = message;
      msgEl.className = 'message-area';
      if (type === "error") msgEl.classList.add('error-message');
      else if (type === "success") msgEl.classList.add('success-message');
    }

    function toggleInactiveAgentsList() {
      const list = document.getElementById('inactiveAgentsList');
      const header = document.querySelector('#inactiveAgentsBox .collapsible');
      list.classList.toggle('collapsed');
      header.classList.toggle('collapsed');
    }

    function formatDuration(value) {
      if (value === null || value === undefined || value === "N/A" || value === "") return "N/A";
      const totalSeconds = Number(value);
      if (isNaN(totalSeconds) || totalSeconds < 0) return "00:00:00";
      const hours = Math.floor(totalSeconds / 3600);
      const minutes = Math.floor((totalSeconds % 3600) / 60);
      const seconds = Math.floor(totalSeconds % 60);
      return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    }
    function escapeSingleQuotes(str) { return String(str || '').replace(/'/g, "\\'"); }
    function showError(error) {
      showLoader(false);
      const errorMessage = (error && error.message) ? error.message : "An unknown error occurred.";
      setUserMessage("Error: " + errorMessage, "error");
    }
    function showErrorInDetailsRow(error, containerId, button){
      if (button) button.textContent = "Error";
      const container = document.getElementById(containerId);
      if (!container) return;
      const errorMessage = (error && error.message) ? error.message : "An unknown error occurred.";
      container.innerHTML = `<h4 style="color: #f04747;">Error loading cases:</h4><p>${errorMessage}</p>`;
    }

    // --- NEW: Function to set up collapsible sections ---
    function setupCollapsibleSections() {
      document.querySelectorAll('.collapsible-header').forEach(header => {
        // Get the content block that is the *next* element
        const content = header.nextElementSibling;

        // Check if content exists
        if (content && content.classList.contains('collapsible-content')) {

          // Set all sections to be expanded by default
          header.classList.add('expanded');
          content.classList.add('expanded');

          // Add the click event listener
          header.addEventListener('click', () => {
            header.classList.toggle('expanded');
            content.classList.toggle('expanded');
          });
        }
      });
    }

    // --- DATA DISPLAY FUNCTIONS ---
    function displayActiveAgents(activeAgents) {
      const activeAgentsList = document.getElementById('activeAgentsList');
      const activeAgentsCount = document.getElementById('activeAgentsCount');
      activeAgentsList.innerHTML = '';
      if (activeAgents && activeAgents.length > 0) {
        activeAgentsCount.textContent = `(${activeAgents.length})`;
        activeAgents.forEach(agent => {
          let timeString = '';
          if (agent.sessionStartTime) {
            const startTime = new Date(agent.sessionStartTime);

            const timeFormat = {
              hour: '2-digit',
              minute: '2-digit'
            };
            const dateFormat = {
              year: 'numeric',
              month: '2-digit',
              day: '2-digit'
            };

            timeString = ` ${startTime.toLocaleDateString('en-GB', dateFormat)} ${startTime.toLocaleTimeString([], timeFormat)}`;
          }

          const listItem = document.createElement('li');
          listItem.innerHTML = `<strong>${agent.agentName}</strong> (${agent.statusDetail}${timeString})`;
          activeAgentsList.appendChild(listItem);
        });
      } else {
        activeAgentsCount.textContent = '(0)';
        activeAgentsList.innerHTML = '<li style="color:var(--text-secondary); font-style:italic;">No agents currently active.</li>';
      }
    }

    function displayInactiveAgents(inactiveAgents) {
      const inactiveAgentsList = document.getElementById('inactiveAgentsList');
      const inactiveAgentsCount = document.getElementById('inactiveAgentsCount');
      inactiveAgentsList.innerHTML = '';
      if (inactiveAgents && inactiveAgents.length > 0) {
        inactiveAgentsCount.textContent = `(${inactiveAgents.length})`;
        inactiveAgents.forEach(agent => {
          const listItem = document.createElement('li');
          listItem.innerHTML = `<strong>${agent.agentName}</strong> (${agent.statusDetail})`;
          inactiveAgentsList.appendChild(listItem);
        });
      } else {
        inactiveAgentsCount.textContent = '(0)';
        inactiveAgentsList.innerHTML = '<li style="color:var(--text-secondary); font-style:italic;">All agents are currently active.</li>';
      }
    }

    function displayAttendanceSummary(attendanceData) {
      showLoader(false);
      const tbody = document.getElementById('agentSummaryBody');
      tbody.innerHTML = '';
      if (!attendanceData || attendanceData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No agent attendance data found.</td></tr>';
        return setUserMessage("No attendance data found.", "status");
      }
      setUserMessage("Attendance summary loaded. Click 'View Cases' for details.", "success");
      attendanceData.forEach(agent => {
        const row = tbody.insertRow();
        const agentDisplayName = agent.agentName || agent.agentEmail;
        row.insertCell().innerHTML = `<span class="agent-name-cell">${agentDisplayName}</span>`;
        row.insertCell().textContent = formatDuration(agent.totalWorkDurationSeconds);
        row.insertCell().textContent = formatDuration(agent.totalBreakDurationSeconds);
        row.insertCell().textContent = formatDuration(agent.totalMeetingDurationSeconds);
        row.insertCell().innerHTML = `<button class="btn-view-cases" onclick="toggleAgentCases(this, '${escapeSingleQuotes(agent.agentEmail)}', '${escapeSingleQuotes(agentDisplayName)}')">View Cases</button>`;
      });
    }
    function displayAgentCaseDetails(caseData, containerId, button) {
      const container = document.getElementById(containerId);
      if (!container) return;
      if (!caseData) {
        container.innerHTML = `<h4 style="color: #f04747;">Error:</h4><p>Received invalid data.</p>`;
        button.textContent = "Error";
        return;
      }
      button.textContent = "Hide Cases";
      let contentHtml = '<h4>Case Activity</h4>';
      if (caseData.length === 0) {
        contentHtml += '<p>No case activity found for this agent in the selected period.</p>';
      } else {
        let tableHtml = `<table><thead><tr><th>Case ID</th><th>Account Name</th><th>Start Time</th><th>End Time</th><th>Idle Time Before</th><th>Current Status</th></tr></thead><tbody>`;
        caseData.forEach(c => {
          tableHtml += `<tr><td>${c.caseId || 'N/A'}</td><td>${c.accountName || 'N/A'}</td><td>${c.startTimeISO ? new Date(c.startTimeISO).toLocaleString() : 'N/A'}</td><td>${c.endTimeISO ? new Date(c.endTimeISO).toLocaleString() : 'N/A'}</td><td>${formatDuration(c.idleTimeBeforeThisCaseSeconds)}</td><td>${c.status || 'N/A'}</td></tr>`;
        });
        tableHtml += '</tbody></table>';
        contentHtml += `<div class="scrollable-table-container">${tableHtml}</div>`;
      }
      container.innerHTML = contentHtml;
    }

    // --- DATA LOADING & EVENT HANDLER FUNCTIONS ---
    function loadActiveAgents() { google.script.run.withSuccessHandler(displayActiveAgents).getActiveAgentStatuses(); }

    function loadInactiveAgents() {
      google.script.run.withSuccessHandler(displayInactiveAgents).getInactiveAgentStatuses();
    }

    function loadManagerData() {
      showLoader(true);
      setUserMessage("Loading attendance summary...", "status");
      document.getElementById('agentSummaryBody').innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px;">Loading...</td></tr>';
      const startDateStr = document.getElementById('startDate').value;
      const useRange = document.getElementById('dateRangeToggle').checked;
      const endDateStr = useRange ? document.getElementById('endDate').value : startDateStr;
      if (!startDateStr) return showError({ message: "Please select a start date." });
      const startDisplay = new Date(startDateStr + "T12:00:00Z").toLocaleDateString(undefined, { timeZone: 'UTC' });
      const endDisplay = new Date(endDateStr + "T12:00:00Z").toLocaleDateString(undefined, { timeZone: 'UTC' });
      document.getElementById('summaryDateDisplay').textContent = (startDateStr === endDateStr) ? `for ${startDisplay}` : `from ${startDisplay} to ${endDisplay}`;

      google.script.run.withSuccessHandler(displayAttendanceSummary).withFailureHandler(showError).getManagerAttendanceSummary(startDateStr, endDateStr);
      loadLeaderboardData(startDateStr, endDateStr);
    }
    function toggleAgentCases(button, agentEmail, agentName) {
      const clickedRow = button.parentElement.parentElement;
      const detailsRowId = `details-row-for-${agentEmail.replace(/[^a-zA-Z0-9]/g, "")}`;
      const existingDetailsRow = document.getElementById(detailsRowId);
      document.querySelectorAll('.details-row').forEach(row => { if (row.id !== detailsRowId) row.remove(); });
      document.querySelectorAll('.btn-view-cases').forEach(btn => { if (btn !== button && btn.textContent !== "View Cases") btn.textContent = "View Cases"; });
      if (existingDetailsRow) {
        existingDetailsRow.remove();
        button.textContent = "View Cases";
      } else {
        button.textContent = "Loading...";
        const newRow = clickedRow.insertAdjacentElement('afterend', document.createElement('tr'));
        newRow.id = detailsRowId;
        newRow.className = 'details-row';
        const cell = newRow.insertCell(0);
        cell.colSpan = 5;
        const containerId = `details-container-for-${agentEmail.replace(/[^a-zA-Z0-9]/g, "")}`;
        cell.innerHTML = `<div class="details-container" id="${containerId}"><h4>Loading cases for ${agentName}...</h4></div>`;
        const startDateStr = document.getElementById('startDate').value;
        const endDateStr = document.getElementById('dateRangeToggle').checked ? document.getElementById('endDate').value : startDateStr;
        google.script.run.withSuccessHandler(caseData => displayAgentCaseDetails(caseData, containerId, button)).withFailureHandler(err => showErrorInDetailsRow(err, containerId, button)).getAgentCasesForDateRange(agentEmail, startDateStr, endDateStr);
      }
    }

    // --- NEW FUNCTIONS FOR AGENT LOG DROPDOWN ---
    function loadAllAgentsForDropdown() {
      google.script.run.withSuccessHandler(displayAgentDropdown).getAllAgents();
    }

    function displayAgentDropdown(agents) {
      const selector = document.getElementById('agentLogSelector');
      selector.innerHTML = ''; // Clear existing options
      if (!agents || agents.length === 0) {
        selector.innerHTML = '<option disabled selected>No agents found</option>';
        return;
      }
      agents.forEach(agent => {
        const option = document.createElement('option');
        option.value = agent.email;
        // Display name and email for clarity
        option.textContent = `${agent.name} (${agent.email})`;
        selector.appendChild(option);
      });
    }

    // --- VERSION INFO FUNCTIONS ---
    function fetchVersionInformation() {
      google.script.run
        .withSuccessHandler(handleVersionDetailsResponse)
        .withFailureHandler(handleVersionDetailsError)
        .getVersionDetails();
    }

    function handleVersionDetailsResponse(versionInfo) {
      const versionDisplayEl = document.getElementById('scriptVersionDisplay');
      const statusMsgEl = document.getElementById('versionStatusMessage');
      const updateNotificationEl = document.getElementById('updateNotificationArea');
      const updateButtonEl = document.getElementById('updateButton');
      const featuresDisplayEl = document.getElementById('updateFeaturesDisplay');
      const versionErrorEl = document.getElementById('versionError');
      if (!versionDisplayEl || !statusMsgEl || !updateNotificationEl) return;

      versionErrorEl.style.display = 'none';
      if (versionInfo && versionInfo.error) {
        versionDisplayEl.textContent = "Error";
        updateNotificationEl.style.display = 'none';
        versionErrorEl.textContent = versionInfo.error;
        versionErrorEl.style.display = 'block';
        return;
      }
      if (versionInfo && versionInfo.runningVersion) {
        versionDisplayEl.textContent = versionInfo.runningVersion;
        const running = parseFloat(versionInfo.runningVersion);
        const latest = parseFloat(versionInfo.latestAdvertisedVersion);
        if (!isNaN(running) && !isNaN(latest) && versionInfo.latestAdvertisedVersion && versionInfo.updateURL && running < latest) {
          updateNotificationEl.style.display = 'block';
          featuresDisplayEl.textContent = versionInfo.updateFeatures || "No features listed.";
          updateButtonEl.onclick = () => promptForUpdate(versionInfo.updateURL, versionInfo.updateFeatures);
        } else {
          statusMsgEl.textContent = "Up to date.";
          updateNotificationEl.style.display = 'none';
        }
      } else {
        versionDisplayEl.textContent = "N/A";
        versionErrorEl.textContent = "Could not retrieve version info.";
        versionErrorEl.style.display = 'block';
      }
    }

    function handleVersionDetailsError(error) {
      console.error("Error fetching version details:", error);
      document.getElementById('scriptVersionDisplay').textContent = "Error";
      document.getElementById('versionError').textContent = "Failed to check for updates.";
      document.getElementById('versionError').style.display = 'block';
    }

    function promptForUpdate(newUrl, features) {
      if (!newUrl) { alert("Update URL is not configured."); return; }
      window.open(newUrl, '_blank');
      const bookmarkShortcut = navigator.platform.toUpperCase().indexOf('MAC') >= 0 ? 'Cmd+D' : 'Ctrl+D';
      let alertMessage = "A new version has opened in a new tab.\n\n";
      if (features) { alertMessage += "New features:\n- " + features.replace(/,\s*/g, "\n- ") + "\n\n"; }
      alertMessage += "Please bookmark the new page (try " + bookmarkShortcut + ") and remove your old bookmark.";
      alert(alertMessage);
    }


    // --- SIDEBAR FUNCTIONS ---
    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('open');
    }
    function loadManagerImportantLinks() {
      google.script.run.withSuccessHandler(displayManagerImportantLinks).getManagerImportantLinks();
    }
    function displayManagerImportantLinks(links) {
      const content = document.getElementById('sidebar-content');
      content.innerHTML = '';
      if (!links || links.length === 0) {
        content.innerHTML = '<p style="color:var(--text-secondary); padding:10px;">No links found.</p>';
        return;
      }
      const groupedLinks = links.reduce((acc, link) => {
        if (!acc[link.category]) { acc[link.category] = []; }
        acc[link.category].push(link);
        return acc;
      }, {});

      for (const category in groupedLinks) {
        const header = document.createElement('h4');
        header.className = 'sidebar-category-header';
        header.textContent = category;
        const linksContainer = document.createElement('div');
        linksContainer.className = 'links-container';
        header.onclick = function() {
          this.classList.toggle('expanded');
          linksContainer.classList.toggle('expanded');
        };
        groupedLinks[category].forEach(link => {
          const linkElement = document.createElement('a');
          linkElement.className = 'link-item';
          linkElement.href = link.url;
          linkElement.target = '_blank';
          linkElement.innerHTML = `<div class="link-item-name">${link.name}</div><p class="link-item-desc">${link.description}</p>`;
          linksContainer.appendChild(linkElement);
        });
        content.appendChild(header);
        content.appendChild(linksContainer);
      }
    }

    // --- APPROVAL WORKFLOW ---
    function loadApprovalRequests() {
      const tbody = document.getElementById('approvalRequestsBody');
      tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:20px;">Loading requests...</td></tr>';
      google.script.run
        .withSuccessHandler(displayApprovalRequests)
        .withFailureHandler(err => {
          showError(err);
          tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; color: var(--red-deny);">Could not load requests.</td></tr>';
        })
        .getPendingApprovalRequests();
    }
    function displayApprovalRequests(requests) {
      const tbody = document.getElementById('approvalRequestsBody');
      tbody.innerHTML = '';
      if (!requests || requests.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:20px;">No pending requests.</td></tr>';
        return;
      }
      requests.forEach(req => {
        const row = tbody.insertRow();
        row.id = `request-row-${req.rowNumber}`;
        const displayOrigTimestamp = req.originalTimestamp ? new Date(req.originalTimestamp).toLocaleString() : 'N/A';
        const displayReqTimestamp = req.requestedTimestamp ? new Date(req.requestedTimestamp).toLocaleString() : 'N/A';

        row.insertCell().textContent = req.agent;
        row.insertCell().textContent = displayOrigTimestamp;
        row.insertCell().textContent = req.originalAction;
        row.insertCell().textContent = req.sessionId;
        row.insertCell().textContent = displayReqTimestamp;
        row.insertCell().textContent = req.reason;
        const actionCell = row.insertCell();
        actionCell.style.textAlign = 'right';
        actionCell.innerHTML = `
          <button class="btn-action btn-approve" onclick="handleApproveAction(${req.rowNumber})">Approve & Apply</button>
          <button class="btn-action btn-deny" onclick="handleDenyAction(${req.rowNumber})">Deny</button>
        `;
      });
    }
    function handleApproveAction(rowNumber) {
      const row = document.getElementById(`request-row-${rowNumber}`);
      if(row) row.cells[6].innerHTML = `<span>Applying...</span>`;
      google.script.run
        .withSuccessHandler(response => {
          setUserMessage(response, "success", 'approvalMessage');
          if (row) row.remove();
          if (document.getElementById('approvalRequestsBody').rows.length === 0) {
            displayApprovalRequests([]);
          }
        })
        .withFailureHandler(err => {
          showError(err);
          loadApprovalRequests();
        })
        .applyCorrection(rowNumber);
    }
    function handleDenyAction(rowNumber) {
      const row = document.getElementById(`request-row-${rowNumber}`);
      if(row) row.cells[6].innerHTML = `<span>Denying...</span>`;
      google.script.run
        .withSuccessHandler(response => {
          setUserMessage(response, "success", 'approvalMessage');
          if (row) row.remove();
            if (document.getElementById('approvalRequestsBody').rows.length === 0) {
              displayApprovalRequests([]);
          }
        })
        .withFailureHandler(err => {
          showError(err);
          loadApprovalRequests();
        })
        .updateRequestStatus(rowNumber, 'Denied');
    }

    // --- NEW MANAGER ATTENDANCE LOG FUNCTIONS ---
    function loadManagerAgentLog() {
      const agentEmail = document.getElementById('agentLogSelector').value;
      const dateFrom = document.getElementById('logDateFrom').value;
      const dateTo = document.getElementById('logDateTo').value;

      if (!agentEmail) {
        return setUserMessage("Please select an agent.", "error", "attendanceLogMessageManager");
      }
      if (!dateFrom || !dateTo) {
        return setUserMessage("Please select both a 'From' and 'To' date.", "error", "attendanceLogMessageManager");
      }

      const loader = document.getElementById('attendanceLogLoaderManager');
      if (loader) loader.style.display = 'inline-block';
      setUserMessage("Loading log for selected agent...", "status", "attendanceLogMessageManager");

      google.script.run
        .withSuccessHandler(displayManagerAgentLog)
        .withFailureHandler(err => {
          showError(err);
          setUserMessage(err.message, "error", "attendanceLogMessageManager");
          if (loader) loader.style.display = 'none';
        })
        .getLogForSelectedAgent(agentEmail, {startDate: dateFrom, endDate: dateTo});
    }

    function displayManagerAgentLog(logs) {
      const loader = document.getElementById('attendanceLogLoaderManager');
      if (loader) loader.style.display = 'none';

      const tbody = document.getElementById('managerLogTableBody');
      tbody.innerHTML = '';

      if (!logs || logs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;">No log entries found for this agent in the selected period.</td></tr>';
        return setUserMessage("No log entries found.", "status", "attendanceLogMessageManager");
      }

      setUserMessage("Log loaded successfully.", "success", "attendanceLogMessageManager");
      logs.forEach(log => {
        const row = tbody.insertRow();
        // Format the ISO date string for friendly display
        row.insertCell().textContent = new Date(log.timestamp).toLocaleString();
        row.insertCell().textContent = log.action;
        row.insertCell().textContent = log.sessionId;
      });
    }

    // --- LEADERBOARD FUNCTIONS ---
    function loadLeaderboardData(startDateStr, endDateStr) {
      document.getElementById('leaderboardBody').innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px;">Loading leaderboard...</td></tr>';
      google.script.run
        .withSuccessHandler(displayLeaderboard)
        .withFailureHandler(err => {
          showError(err);
          document.getElementById('leaderboardBody').innerHTML = '<tr><td colspan="4" style="text-align:center; color: var(--red-deny);">Could not load leaderboard data.</td></tr>';
        })
        .getLeaderboardData(startDateStr, endDateStr);
    }
    function displayLeaderboard(leaderboardData) {
      const tbody = document.getElementById('leaderboardBody');
      tbody.innerHTML = '';
      if (!leaderboardData || leaderboardData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px;">No data available for the selected period.</td></tr>';
        return;
      }
      leaderboardData.forEach(agent => {
        const row = tbody.insertRow();
        row.setAttribute('onclick', `toggleLeaderboardDetails(this, '${escapeSingleQuotes(agent.agentName)}')`);
        row.insertCell().textContent = agent.rank;
        row.insertCell().innerHTML = `<span class="agent-name-cell">${agent.agentName}</span>`;
        row.insertCell().textContent = agent.totalCases;
        row.insertCell().textContent = formatDuration(agent.avgHandlingTime);
      });
    }
    function toggleLeaderboardDetails(clickedRow, agentEmail) {
      const detailsRowId = `leaderboard-details-for-${agentEmail.replace(/[^a-zA-Z0-9]/g, "")}`;
      const existingDetailsRow = document.getElementById(detailsRowId);
      document.querySelectorAll('.details-row').forEach(row => { if (row.id !== detailsRowId) row.remove(); });
      if (existingDetailsRow) {
        existingDetailsRow.remove();
      } else {
        const newRow = clickedRow.insertAdjacentElement('afterend', document.createElement('tr'));
        newRow.id = detailsRowId;
        newRow.className = 'details-row';
        const cell = newRow.insertCell(0);
        cell.colSpan = 4;
        cell.innerHTML = `<div class="details-container"><h4>Loading case details for ${agentEmail}...</h4></div>`;
        const startDateStr = document.getElementById('startDate').value;
        const endDateStr = document.getElementById('dateRangeToggle').checked ? document.getElementById('endDate').value : startDateStr;
        google.script.run
          .withSuccessHandler(caseDetails => {
            let contentHtml = `<div class="leaderboard-details-container"><h4>Case Details</h4>`;
            if (caseDetails && caseDetails.length > 0) {
              let tableHtml = `<table><thead><tr><th>Case ID</th><th>Account Name</th><th>Handling Time</th></tr></thead><tbody>`;
              caseDetails.forEach(c => {
                tableHtml += `<tr><td>${c.caseId || 'N/A'}</td><td>${c.accountName || 'N/A'}</td><td>${formatDuration(c.handlingTime)}</td></tr>`;
              });
              tableHtml += `</tbody></table>`;
              contentHtml += `<div class="scrollable-table-container">${tableHtml}</div>`;
            } else {
              contentHtml += `<p>No completed cases found for this agent in the selected period.</p>`;
            }
            contentHtml += `</div>`;
            cell.querySelector('.details-container').innerHTML = contentHtml;
          })
          .withFailureHandler(err => {
            cell.querySelector('.details-container').innerHTML = `<h4 style="color: #f04747;">Error:</h4><p>${err.message}</p>`;
          })
          .getCaseDetailsForAgent(agentEmail, startDateStr, endDateStr);
      }
    }

    // --- ANOMALY FUNCTIONS ---
    function loadAnomalies() {
      const startDate = document.getElementById('anomalyStartDate').value;
      const endDate = document.getElementById('anomalyEndDate').value;
      if (!startDate || !endDate) {
        return setUserMessage("Please select a start and end date for anomaly detection.", "error", "anomalyMessage");
      }
      showLoader(true, 'anomalyLoader');
      setUserMessage("Scanning for anomalies...", "status", "anomalyMessage");
      google.script.run
        .withSuccessHandler(displayAnomalies)
        .withFailureHandler(err => {
          showLoader(false, 'anomalyLoader');
          setUserMessage(err.message, "error", "anomalyMessage");
        })
        .getAnomalies(startDate, endDate);
    }

    function displayAnomalies(anomalies) {
      showLoader(false, 'anomalyLoader');
      const tbody = document.getElementById('anomalyBody');
      tbody.innerHTML = '';
      if (!anomalies || anomalies.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">No anomalies found.</td></tr>';
        return;
      }
      setUserMessage(`Found ${anomalies.length} anomalies.`, "success", "anomalyMessage");
      anomalies.forEach(anomaly => {
        const row = tbody.insertRow();
        row.insertCell().textContent = anomaly.caseId;
        row.insertCell().textContent = anomaly.type;
        row.insertCell().textContent = anomaly.details;
        const actionCell = row.insertCell();
        if (anomaly.type === 'Negative Duration') {
          actionCell.innerHTML = `<button class="btn-action btn-view-cases" onclick="previewFix('${anomaly.caseId}')">Fix Calculation</button>`;
        }
      });
    }

    let caseIdToFix = null;

function previewFix(caseId) {
    caseIdToFix = caseId;
    document.getElementById('fix-case-id').textContent = caseId;
    document.getElementById('fix-modal').style.display = 'flex';

    // Reset state
    document.getElementById('problematic-logs-container').innerHTML = '<div class="loader" style="display:block; margin: 10px auto;"></div>';
    ['current-aht', 'proposed-aht', 'current-pause', 'proposed-pause', 'current-escalation', 'proposed-escalation'].forEach(id => {
        document.getElementById(id).textContent = '...';
    });

    google.script.run
        .withSuccessHandler(displayPreviewData)
        .withFailureHandler(err => {
            document.getElementById('problematic-logs-container').innerHTML = `<p class="error-message">Error loading preview: ${err.message}</p>`;
        })
        .previewHandlingTimeFix(caseId);
}

function displayPreviewData(previewData) {
    // Defensive check for null response from server
    if (!previewData) {
        document.getElementById('problematic-logs-container').innerHTML = `<p class="error-message">Error: Received no data from the server. The calculation preview could not be loaded.</p>`;
        ['current-aht', 'proposed-aht', 'current-pause', 'proposed-pause', 'current-escalation', 'proposed-escalation'].forEach(id => {
            const el = document.getElementById(id);
            if(el) el.textContent = 'Error';
        });
        return;
    }
    if (previewData.error) {
        document.getElementById('problematic-logs-container').innerHTML = `<p class="error-message">${previewData.error}</p>`;
        return;
    }

    document.getElementById('current-aht').textContent = previewData.currentAHT;
    document.getElementById('proposed-aht').textContent = previewData.proposedAHT;
    document.getElementById('current-pause').textContent = previewData.currentPause;
    document.getElementById('proposed-pause').textContent = previewData.proposedPause;
    document.getElementById('current-escalation').textContent = previewData.currentEscalation;
    document.getElementById('proposed-escalation').textContent = previewData.proposedEscalation;

    const logsContainer = document.getElementById('problematic-logs-container');
    logsContainer.innerHTML = '';
    if (previewData.problematicLogs && previewData.problematicLogs.length > 0) {
        let tableHtml = '<table class="simple-table"><thead><tr><th>Delete?</th><th>Type</th><th>Log ID</th><th>Start Time</th><th>End Time</th><th>Reason</th></tr></thead><tbody>';
        previewData.problematicLogs.forEach(log => {
            tableHtml += `
                <tr>
                    <td><input type="checkbox" class="log-checkbox" data-id="${log.id}" data-type="${log.type}"></td>
                    <td>${log.type}</td>
                    <td>${log.id}</td>
                    <td>${new Date(log.start).toLocaleString()}</td>
                    <td>${new Date(log.end).toLocaleString()}</td>
                    <td>${log.reason}</td>
                </tr>`;
        });
        tableHtml += '</tbody></table>';
        logsContainer.innerHTML = tableHtml;
    } else {
        logsContainer.innerHTML = '<p>No specific overlapping logs found, but recalculation is recommended to fix stored values.</p>';
    }
    }

    function deleteSelectedLogs() {
        const checkboxes = document.querySelectorAll('.log-checkbox:checked');
        if (checkboxes.length === 0) {
            alert("Please select at least one log entry to delete.");
            return;
        }

        const logsToDelete = Array.from(checkboxes).map(cb => ({
            id: cb.dataset.id,
            type: cb.dataset.type
        }));

        const btn = document.getElementById('delete-logs-btn');
        btn.textContent = 'Deleting...';
        btn.disabled = true;

        google.script.run
            .withSuccessHandler(response => {
                alert(response);
                // Refresh the preview to show the impact of the deletion
                previewFix(caseIdToFix);
                btn.textContent = 'Delete Selected Logs';
                btn.disabled = false;
            })
            .withFailureHandler(err => {
                alert('Error deleting logs: ' + err.message);
                btn.textContent = 'Delete Selected Logs';
                btn.disabled = false;
            })
            .deleteLogEntries(logsToDelete);
}

    function closeFixModal() {
        document.getElementById('fix-modal').style.display = 'none';
        caseIdToFix = null;
    }

    function applyFix() {
        if (!caseIdToFix) return;
        const btn = document.getElementById('confirm-fix-btn');
        btn.textContent = 'Saving...';
        btn.disabled = true;

        google.script.run
            .withSuccessHandler(response => {
                alert(response);
                closeFixModal();
                loadAnomalies(); // This will refresh the list of anomalies
                btn.textContent = 'Confirm & Save Changes'; // Reset button text
                btn.disabled = false; // Re-enable button
            })
            .withFailureHandler(err => {
                alert('Error: ' + err.message);
                btn.textContent = 'Confirm & Save Changes'; // Reset button text
                btn.disabled = false; // Re-enable button
            })
            .fixHandlingTimeAnomaly(caseIdToFix);
    }
    // --- INITIALIZATION ---
    function initializePage() {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('startDate').value = today;
      document.getElementById('endDate').value = today;
      document.getElementById('anomalyStartDate').value = today;
      document.getElementById('anomalyEndDate').value = '2030-01-01';
      toggleDateRange();
      loadActiveAgents();
      loadInactiveAgents();
      document.getElementById('agentSummaryBody').innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px;">Click "Load Data" to generate the report.</td></tr>';
      loadApprovalRequests();
      document.getElementById('leaderboardBody').innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px;">Click "Load Data" to generate the report.</td></tr>';

      loadManagerImportantLinks();
      loadAllAgentsForDropdown();
      fetchVersionInformation();
      loadAnomalies();

      // --- NEW: Call the setup function on page load ---
      setupCollapsibleSections();
    }
    window.addEventListener('load', initializePage);

    function addUserAccess() {
      const email = document.getElementById('newUserEmail').value;
      if (!email) {
        return setUserMessage("Please enter an email address.", "error", "userAccessMessage");
      }
      showLoader(true, 'addUserLoader');
      google.script.run
        .withSuccessHandler(response => {
          showLoader(false, 'addUserLoader');
          setUserMessage(response, "success", "userAccessMessage");
          loadAuthorizedUsers();
        })
        .withFailureHandler(err => {
          showLoader(false, 'addUserLoader');
          setUserMessage(err.message, "error", "userAccessMessage");
        })
        .addUserAccess(email);
    }

    function loadAuthorizedUsers() {
      google.script.run
        .withSuccessHandler(displayAuthorizedUsers)
        .withFailureHandler(err => {
          const tbody = document.getElementById('authorizedUsersBody');
          tbody.innerHTML = '<tr><td colspan="2" style="text-align:center; color:red;">Could not load users.</td></tr>';
        })
        .getAuthorizedUsers();
    }

    function displayAuthorizedUsers(users) {
      const tbody = document.getElementById('authorizedUsersBody');
      tbody.innerHTML = '';
      if (!users || users.length === 0) {
        tbody.innerHTML = '<tr><td colspan="2" style="text-align:center;">No authorized users found.</td></tr>';
        return;
      }
      users.forEach(user => {
        const row = tbody.insertRow();
        row.insertCell().textContent = user;
        const actionCell = row.insertCell();
        const removeButton = document.createElement('button');
        removeButton.className = 'btn-action btn-deny';
        removeButton.textContent = 'Remove';
        removeButton.onclick = () => removeUserAccess(user);
        actionCell.appendChild(removeButton);
      });
    }

    function removeUserAccess(email) {
      if (!confirm(`Are you sure you want to remove access for ${email}?`)) {
        return;
      }
      setUserMessage("Removing user...", "status", "userAccessMessage");
      google.script.run
        .withSuccessHandler(response => {
          setUserMessage(response, "success", "userAccessMessage");
          loadAuthorizedUsers();
        })
        .withFailureHandler(err => {
          setUserMessage(err.message, "error", "userAccessMessage");
        })
        .removeUserAccess(email);
    }
</script>
</body>
</html>
