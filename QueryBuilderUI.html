<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <title>Dynamic Query Engine</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Fira+Code&display=swap" rel="stylesheet">
  <style>
    :root {
      --background-main: #F4F7F6;
      --card-background: #FFFFFF;
      --primary-accent: #007B5F;
      --text-primary: #111827;
      --text-secondary: #6B7280;
      --border-light: #E5E7EB;
      --action-blue: #3B82F6;
      --danger-red: #EF4444;
    }
    body { font-family: 'Inter', sans-serif; background-color: var(--background-main); color: var(--text-primary); margin: 0; padding: 20px; }
    h1, h2, h3 { color: var(--text-primary); font-weight: 700; }
    h1 { font-size: 2em; text-align: center; margin-bottom: 20px; }
    .container { max-width: 1200px; margin: 0 auto; background: var(--card-background); border-radius: 12px; padding: 25px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
    .query-builder-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }
    .clause-section { border: 1px solid var(--border-light); border-radius: 8px; padding: 20px; }
    .clause-section h3 { margin: 0 0 15px 0; padding-bottom: 10px; border-bottom: 1px solid var(--border-light); }
    #where-clause-container { background-color: #F9FAFB; padding: 15px; border-radius: 6px; }
    .filter-group { background-color: var(--card-background); border: 1px dashed var(--border-light); border-radius: 6px; padding: 15px; margin-bottom: 15px; }
    .group-controls { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
    .group-logic-toggle { display: flex; align-items: center; gap: 5px; }
    .filter-rule { display: grid; grid-template-columns: repeat(3, 1fr) auto; gap: 10px; align-items: center; margin-bottom: 10px; }
    .filter-rule select, .filter-rule input { width: 100%; padding: 8px; border-radius: 6px; border: 1px solid var(--border-light); font-size: 14px; }
    .sortable-item { display: grid; grid-template-columns: 1fr 1fr auto; gap: 10px; align-items: center; margin-bottom: 10px; }
    .sortable-item select { width: 100%; padding: 8px; border-radius: 6px; border: 1px solid var(--border-light); font-size: 14px; }
    #groupby-container .sortable-item { grid-template-columns: 1fr auto; } /* Group by only needs column and remove button */
    .aggregation-rule { display: grid; grid-template-columns: auto 1fr auto; gap: 10px; align-items: center; margin-bottom: 10px; }
    .aggregation-rule select { padding: 8px; border-radius: 6px; border: 1px solid var(--border-light); font-size: 14px; }
    .btn { cursor: pointer; border: none; border-radius: 6px; font-weight: 600; transition: all 0.2s ease; padding: 8px 14px; }
    .btn-primary { background-color: var(--primary-accent); color: white; }
    .btn-secondary { background-color: var(--border-light); color: var(--text-primary); }
    .btn-add { background-color: var(--action-blue); color: white; }
    .btn-remove { background-color: var(--danger-red); color: white; padding: 6px 10px; font-size: 18px; line-height: 1; }
    .json-output-section textarea { width: 100%; box-sizing: border-box; height: 120px; font-family: 'Fira Code', monospace; font-size: 13px; padding: 10px; border: 1px solid var(--border-light); border-radius: 6px; }
    .main-actions { display: flex; justify-content: flex-end; gap: 15px; margin-top: 25px; padding-top: 25px; border-top: 1px solid var(--border-light); }
    .load-options { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px; }
    .load-options select { width: 100%; padding: 8px; border-radius: 6px; border: 1px solid var(--border-light); font-size: 14px; }
    .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; }
    .modal-content { background: var(--card-background); padding: 25px; border-radius: 8px; width: 90%; max-width: 500px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
    .modal-content h2 { margin-top: 0; }
    .modal-content input, .modal-content textarea { width: 100%; box-sizing: border-box; padding: 10px; border-radius: 6px; border: 1px solid var(--border-light); margin-bottom: 15px; }
    .modal-content textarea { height: 80px; }
    .modal-actions { display: flex; justify-content: flex-end; gap: 10px; }
  </style>
</head>
<body>

  <div class="container">
    <h1>Dynamic Query Engine</h1>

    <div class="query-builder-grid">
      <!-- LEFT COLUMN -->
      <div>
        <div class="clause-section">
          <h3>SELECT Columns</h3>
          <div id="select-columns-list">
            <!-- Checkboxes will be dynamically inserted here -->
            <p style="color: var(--text-secondary);">Select a sheet to see columns.</p>
          </div>
        </div>
      </div>

      <!-- RIGHT COLUMN -->
      <div>
        <div class="clause-section">
          <h3>FROM Sheets (UNION)</h3>
          <div id="from-sheets-list">
            <!-- Sheet checkboxes will be here -->
          </div>
        </div>
      </div>
    </div>

    <div class="clause-section" style="margin-top: 25px;">
        <h3>WHERE Clause</h3>
        <div class="group-controls">
            <div class="group-logic-toggle">
                <span>Match</span>
                <select id="root-logic-selector">
                    <option value="AND">ALL</option>
                    <option value="OR">ANY</option>
                </select>
                <span>of the following groups:</span>
            </div>
            <button class="btn btn-add" onclick="addGroup()">+ Add Group</button>
        </div>
        <div id="where-clause-container">
            <!-- Filter groups will be dynamically inserted here -->
        </div>
    </div>

    <div class="query-builder-grid" style="margin-top: 25px;">
        <div class="clause-section">
          <h3>GROUP BY</h3>
          <div id="groupby-container">
            <!-- Group by items will be added here -->
          </div>
          <button class="btn btn-secondary" onclick="addSortableItem('groupby-container', 'Group By')">+ Add Grouping</button>
        </div>
        <div class="clause-section">
          <h3>ORDER BY</h3>
          <div id="orderby-container">
             <!-- Order by items will be added here -->
          </div>
          <button class="btn btn-secondary" onclick="addSortableItem('orderby-container', 'Order By')">+ Add Sorting</button>
        </div>
    </div>

    <div class="json-output-section" style="margin-top: 25px;">
      <h2>Query Formula (JSON)</h2>
      <textarea id="query-formula-json" readonly></textarea>
      <div class="load-options">
        <div>
          <h3>Load from Formula</h3>
          <textarea id="load-formula-json" placeholder="Paste a previously saved query formula here..."></textarea>
          <button class="btn btn-secondary" style="margin-top: 10px;" onclick="loadQueryFromJson()">Load Query</button>
        </div>
        <div>
            <h3>Load from Library</h3>
            <select id="query-library-selector"><option>Loading library...</option></select>
            <button class="btn btn-secondary" style="margin-top: 10px;" onclick="loadQueryFromLibrary()">Load Selected</button>
        </div>
      </div>
    </div>

    <div class="clause-section" style="margin-top: 25px;">
        <h3>Actions</h3>
        <div id="action-container">
            <div class="action-item">
                <label><input type="checkbox" id="email-notification-checkbox" onchange="toggleEmailInputs()"> Send Email Notification</label>
            </div>
            <div id="email-inputs" style="display: none; margin-top: 10px;">
                <input type="email" id="email-recipient" placeholder="Recipient Email (required)">
                <input type="email" id="email-cc" placeholder="CC Emails (comma-separated, optional)" style="margin-top: 5px;" onchange="updateQueryJson()">
            </div>
        </div>
    </div>

    <div class="main-actions">
      <button class="btn btn-secondary" onclick="openSaveToLibraryModal()">Save to Library</button>
      <button class="btn btn-secondary" onclick="openScheduleModal()">Schedule</button>
      <button class="btn btn-primary" onclick="runQuery()">Run Query</button>
    </div>
  </div>

  <div id="schedule-modal" class="modal-backdrop" style="display: none;">
    <div class="modal-content">
      <h2>Schedule Query</h2>
      <p>Schedule this query to run at a future time or on a recurring basis.</p>

      <select id="schedule-type-selector" onchange="toggleScheduleInputs()">
        <option value="one-time">One-Time</option>
        <option value="recurring">Recurring</option>
      </select>

      <div id="one-time-schedule-inputs" style="margin-top: 15px;">
        <label for="schedule-datetime">Execution Time:</label>
        <input type="datetime-local" id="schedule-datetime">
      </div>

      <div id="recurring-schedule-inputs" style="display: none; margin-top: 15px;">
        <label for="schedule-cron">Cron String:</label>
        <input type="text" id="schedule-cron" placeholder="e.g., 0 9 * * 1 for 9 AM every Monday">
        <a href="https://crontab.guru/" target="_blank" style="font-size: 12px; color: var(--text-secondary);">Cron string builder help</a>
      </div>

      <div class="modal-actions" style="margin-top: 20px;">
        <button class="btn btn-secondary" onclick="closeScheduleModal()">Cancel</button>
        <button class="btn btn-primary" onclick="submitSchedule()">Schedule</button>
      </div>
    </div>
  </div>

  <div id="save-modal" class="modal-backdrop" style="display: none;">
    <div class="modal-content">
      <h2>Save Query to Library</h2>
      <input type="text" id="save-query-name" placeholder="Query Name (required)">
      <textarea id="save-query-description" placeholder="Description (optional)"></textarea>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeSaveModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveToLibrary()">Save</button>
      </div>
    </div>
  </div>

  <script>
    let allSheetHeaders = {}; // Cache for storing headers: { sheetName: ['col1', 'col2'] }
    let availableColumns = []; // The union of all columns from selected sheets

    const operators = [
        { value: 'is', text: 'is' }, { value: 'is_not', text: 'is not' },
        { value: 'is_one_of', text: 'is one of' }, { value: 'is_not_one_of', text: 'is not one of' },
        { value: 'contains', text: 'contains' }, { value: 'does_not_contain', text: 'does not contain' },
        { value: 'starts_with', text: 'starts with' }, { value: 'does_not_start_with', text: 'does not start with' },
        { value: 'ends_with', text: 'ends with' }, { value: 'does_not_end_with', text: 'does not end with' },
        { value: 'is_between', text: 'is between' }, { value: 'is_not_between', text: 'is not between' },
        { value: 'is_greater_than', text: 'is >' }, { value: 'is_less_than', text: 'is <' },
        { value: 'is_greater_than_or_equal_to', text: 'is >=' }, { value: 'is_less_than_or_equal_to', text: 'is <=' },
        { value: 'is_blank', text: 'is blank' }, { value: 'is_not_blank', text: 'is not blank' },
        { value: 'matches_regex', text: 'matches regex' }, { value: 'does_not_match_regex', text: 'does not match regex' }
    ];

    let queryLibrary = [];
    window.addEventListener('load', initializeQueryBuilder);

    function initializeQueryBuilder() {
      google.script.run.withSuccessHandler(populateSheetSelector).withFailureHandler(handleError).getAllSheetNames();
      google.script.run.withSuccessHandler(populateQueryLibrary).withFailureHandler(handleError).getQueriesFromLibrary();
      addGroup();
      updateQueryJson();
    }

    function populateQueryLibrary(queries) {
        queryLibrary = queries;
        const selector = document.getElementById('query-library-selector');
        selector.innerHTML = '<option value="">Select a saved query...</option>';
        queries.forEach((q, index) => {
            const option = document.createElement('option');
            option.value = index;
            option.textContent = q.name;
            option.title = q.description;
            selector.appendChild(option);
        });
    }

    function handleError(error) {
      alert(`Error: ${error.message}`);
    }

    function populateSheetSelector(sheetNames) {
      const container = document.getElementById('from-sheets-list');
      container.innerHTML = '';
      sheetNames.forEach(name => {
        const div = document.createElement('div');
        div.innerHTML = `<label><input type="checkbox" name="sheetName" value="${name}" onchange="handleSheetSelectionChange()"> ${name}</label>`;
        container.appendChild(div);
      });
    }

    function handleSheetSelectionChange() {
        return new Promise((resolve, reject) => {
            const selectedSheets = getSelectedSheets();
            const promises = [];

            selectedSheets.forEach(sheetName => {
                if (!allSheetHeaders[sheetName]) {
                    promises.push(new Promise((resolve, reject) => {
                        google.script.run
                            .withSuccessHandler(headers => {
                                allSheetHeaders[sheetName] = headers;
                                resolve();
                            })
                            .withFailureHandler(reject)
                            .getSheetHeaders(sheetName);
                    }));
                }
            });

            Promise.all(promises)
                .then(() => {
                    updateAvailableColumns();
                    updateAllColumnDropdowns();
                    updateQueryJson();
                    resolve();
                })
                .catch(reject);
        });
    }

    function getSelectedSheets() {
        return Array.from(document.querySelectorAll('[name="sheetName"]:checked')).map(cb => cb.value);
    }

    function updateAvailableColumns() {
        const selectedSheets = getSelectedSheets();
        const columnSet = new Set();
        selectedSheets.forEach(sheetName => {
            (allSheetHeaders[sheetName] || []).forEach(col => columnSet.add(col));
        });
        availableColumns = Array.from(columnSet).sort();
        populateSelectColumns(availableColumns);
    }

    function populateSelectColumns(columns) {
        const container = document.getElementById('select-columns-list');
        container.innerHTML = '';
        if (columns.length === 0) {
            container.innerHTML = '<p style="color: var(--text-secondary);">Select a sheet to see columns.</p>';
            return;
        }
        columns.forEach(col => {
            const div = document.createElement('div');
            div.innerHTML = `<label><input type="checkbox" name="selectColumn" value="${col}" onchange="updateQueryJson()"> ${col}</label>`;
            container.appendChild(div);
        });
    }

    function addGroup() {
        const groupId = `group-${Date.now()}`;
        const group = document.createElement('div');
        group.className = 'filter-group';
        group.id = groupId;
        group.innerHTML = `
            <div class="group-controls">
                <div class="group-logic-toggle">
                    <span>Match</span>
                    <select onchange="updateQueryJson()">
                        <option value="AND">ALL</option>
                        <option value="OR">ANY</option>
                    </select>
                    <span>of the following rules:</span>
                </div>
                <div>
                    <button class="btn btn-add" onclick="addRule('${groupId}')">+ Add Rule</button>
                    <button class="btn btn-remove" onclick="this.parentElement.parentElement.parentElement.remove(); updateQueryJson();">&times;</button>
                </div>
            </div>
            <div class="rules-container"></div>
        `;
        document.getElementById('where-clause-container').appendChild(group);
        addRule(groupId); // Add a default rule to the new group
        updateQueryJson();
    }

    function addRule(groupId) {
        const ruleId = `rule-${Date.now()}`;
        const rule = document.createElement('div');
        rule.className = 'filter-rule';
        rule.id = ruleId;

        const columnOptions = availableColumns.map(c => `<option value="${c}">${c}</option>`).join('');
        const operatorOptions = operators.map(o => `<option value="${o.value}">${o.text}</option>`).join('');

        rule.innerHTML = `
            <select class="column-selector" onchange="updateQueryJson()">${columnOptions}</select>
            <select class="operator-selector" onchange="updateQueryJson()">${operatorOptions}</select>
            <input type="text" placeholder="Value" oninput="updateQueryJson()">
            <button class="btn btn-remove" onclick="this.parentElement.remove(); updateQueryJson();">&times;</button>
        `;
        document.querySelector(`#${groupId} .rules-container`).appendChild(rule);
        updateQueryJson();
    }

    function updateAllColumnDropdowns() {
        const columnOptions = availableColumns.map(c => `<option value="${c}">${c}</option>`).join('');
        document.querySelectorAll('.column-selector').forEach(sel => {
            const currentValue = sel.value;
            sel.innerHTML = columnOptions;
            if (availableColumns.includes(currentValue)) {
                sel.value = currentValue;
            }
        });
    }

    function updateQueryJson() {
        const hasGroupBy = document.querySelector('#groupby-container .sortable-item');

        const query = {
            select: [],
            from: getSelectedSheets(),
            where: {
                logic: document.getElementById('root-logic-selector').value,
                groups: []
            },
            groupBy: [],
            orderBy: []
        };

        if (hasGroupBy) {
            // If GROUP BY is active, SELECT must contain group by columns + aggregations
            document.querySelectorAll('#groupby-container .column-selector').forEach(sel => {
                query.select.push(sel.value);
            });
            document.querySelectorAll('.aggregation-rule').forEach(aggEl => {
                const func = aggEl.querySelector('.aggregation-function-selector').value;
                const col = aggEl.querySelector('.column-selector').value;
                if (col) query.select.push(`${func}(${col})`);
            });
        } else {
            // No GROUP BY, SELECT is based on checkboxes
            query.select = Array.from(document.querySelectorAll('[name="selectColumn"]:checked')).map(cb => cb.value);
        }


        document.querySelectorAll('.filter-group').forEach(groupEl => {
            const group = {
                logic: groupEl.querySelector('select').value,
                rules: []
            };
            groupEl.querySelectorAll('.filter-rule').forEach(ruleEl => {
                group.rules.push({
                    column: ruleEl.querySelector('.column-selector').value,
                    operator: ruleEl.querySelector('.operator-selector').value,
                    value: ruleEl.querySelector('input[type="text"]').value
                });
            });
            if (group.rules.length > 0) query.where.groups.push(group);
        });

        document.querySelectorAll('#groupby-container .sortable-item').forEach(item => {
            query.groupBy.push(item.querySelector('.column-selector').value);
        });

        document.querySelectorAll('#orderby-container .sortable-item').forEach(item => {
            query.orderBy.push({
                column: item.querySelector('.column-selector').value,
                direction: item.querySelector('.direction-selector').value
            });
        });

        const sendEmail = document.getElementById('email-notification-checkbox').checked;
        if (sendEmail) {
            query.action = {
                type: 'email',
                recipient: document.getElementById('email-recipient').value,
                cc: document.getElementById('email-cc').value
            };
        }

        document.getElementById('query-formula-json').value = JSON.stringify(query, null, 2);

        // Toggle aggregation UI visibility
        toggleAggregationUI(query.groupBy.length > 0);
    }

    function toggleEmailInputs() {
        const isChecked = document.getElementById('email-notification-checkbox').checked;
        document.getElementById('email-inputs').style.display = isChecked ? 'block' : 'none';
        updateQueryJson();
    }

    function toggleAggregationUI(show) {
        const selectContainer = document.getElementById('select-columns-list');
        if (show) {
            if (!document.getElementById('aggregation-select-ui')) {
                selectContainer.innerHTML = `
                    <div id="aggregation-select-ui">
                         <p style="color: var(--text-secondary);">Columns in GROUP BY are automatically selected.</p>
                         <h4>Aggregations</h4>
                         <div id="aggregation-rules-container"></div>
                         <button class="btn btn-secondary" onclick="addAggregationRule()">+ Add Aggregation</button>
                    </div>
                `;
                addAggregationRule();
            }
        } else {
            if (document.getElementById('aggregation-select-ui')) {
                populateSelectColumns(availableColumns);
            }
        }
    }

    function addAggregationRule() {
        const container = document.getElementById('aggregation-rules-container');
        const rule = document.createElement('div');
        rule.className = 'aggregation-rule';
        const columnOptions = availableColumns.map(c => `<option value="${c}">${c}</option>`).join('');
        rule.innerHTML = `
            <select class="aggregation-function-selector" onchange="updateQueryJson()">
                <option value="COUNT">COUNT</option>
                <option value="SUM">SUM</option>
                <option value="AVG">AVG</option>
            </select>
            ( <select class="column-selector" onchange="updateQueryJson()"><option value="">Select column...</option>${columnOptions}</select> )
            <button class="btn btn-remove" onclick="this.parentElement.remove(); updateQueryJson();">&times;</button>
        `;
        container.appendChild(rule);
        updateQueryJson();
    }


    function addSortableItem(containerId, type) {
        const container = document.getElementById(containerId);
        const item = document.createElement('div');
        item.className = 'sortable-item';
        const columnOptions = availableColumns.map(c => `<option value="${c}">${c}</option>`).join('');

        let innerHtml = `<select class="column-selector" onchange="updateQueryJson()">${columnOptions}</select>`;
        if (type === 'Order By') {
            innerHtml += `
                <select class="direction-selector" onchange="updateQueryJson()">
                    <option value="ASC">Ascending</option>
                    <option value="DESC">Descending</option>
                </select>
            `;
        }
        innerHtml += `<button class="btn btn-remove" onclick="this.parentElement.remove(); updateQueryJson();">&times;</button>`;
        item.innerHTML = innerHtml;
        container.appendChild(item);
        updateQueryJson();
    }

    function loadQueryFromLibrary() {
        const selector = document.getElementById('query-library-selector');
        const selectedIndex = selector.value;
        if (selectedIndex !== "" && queryLibrary[selectedIndex]) {
            const jsonString = queryLibrary[selectedIndex].queryJson;
            document.getElementById('load-formula-json').value = jsonString;
            loadQueryFromJson();
        }
    }

    async function loadQueryFromJson() {
        const jsonString = document.getElementById('load-formula-json').value;
        try {
            const query = JSON.parse(jsonString);
            await rebuildUiFromQuery(query);
        } catch (e) {
            alert("Invalid JSON format. Please check the pasted formula.");
        }
    }

    async function rebuildUiFromQuery(query) {
        // Clear existing UI state
        document.querySelectorAll('.filter-group').forEach(g => g.remove());
        document.querySelectorAll('#groupby-container .sortable-item').forEach(i => i.remove());
        document.querySelectorAll('#orderby-container .sortable-item').forEach(i => i.remove());

        // Set FROM
        document.querySelectorAll('[name="sheetName"]').forEach(cb => {
            cb.checked = query.from.includes(cb.value);
        });

        // Wait for the async column loading to complete
        await handleSheetSelectionChange();

        // Now that columns are loaded, proceed with the rest of the UI

        // Set SELECT
        if (query.groupBy && query.groupBy.length > 0) {
            toggleAggregationUI(true); // Ensures the UI container is visible

            const aggContainer = document.getElementById('aggregation-rules-container');
            aggContainer.innerHTML = ''; // Clear any default rules

            const aggregations = query.select.filter(s => s.includes('('));
            const aggRegex = /(\w+)\((.*?)\)/;

            aggregations.forEach(aggString => {
                const match = aggString.match(aggRegex);
                if (match) {
                    const func = match[1];
                    const col = match[2];

                    addAggregationRule(); // Add a new row

                    const allAggRules = aggContainer.querySelectorAll('.aggregation-rule');
                    const newRule = allAggRules[allAggRules.length - 1]; // Get the one we just added

                    newRule.querySelector('.aggregation-function-selector').value = func;
                    newRule.querySelector('.column-selector').value = col;
                }
            });

            // If there were no aggregations in the query, add one blank one for the user
            if (aggregations.length === 0) {
                addAggregationRule();
            }

        } else {
            toggleAggregationUI(false);
            document.querySelectorAll('[name="selectColumn"]').forEach(cb => {
                cb.checked = query.select.includes(cb.value);
            });
        }

        // Set WHERE
        if(query.where && query.where.groups){
            query.where.groups.forEach(groupData => {
                addGroup();
                const allGroups = document.querySelectorAll('.filter-group');
                const newGroup = allGroups[allGroups.length - 1];
                newGroup.querySelector('select').value = groupData.logic;
                // Remove the default rule that addGroup creates
                newGroup.querySelector('.filter-rule').remove();
                groupData.rules.forEach(ruleData => {
                    addRule(newGroup.id);
                    const allRules = newGroup.querySelectorAll('.filter-rule');
                    const newRule = allRules[allRules.length - 1];
                    newRule.querySelector('.column-selector').value = ruleData.column;
                    newRule.querySelector('.operator-selector').value = ruleData.operator;
                    newRule.querySelector('input[type="text"]').value = ruleData.value;
                });
            });
        }


        // Set GROUP BY
        if(query.groupBy){
            query.groupBy.forEach(col => {
                addSortableItem('groupby-container', 'Group By');
                const allItems = document.querySelectorAll('#groupby-container .sortable-item');
                allItems[allItems.length - 1].querySelector('.column-selector').value = col;
            });
        }

        // Set ORDER BY
         if(query.orderBy){
            query.orderBy.forEach(sort => {
                addSortableItem('orderby-container', 'Order By');
                const allItems = document.querySelectorAll('#orderby-container .sortable-item');
                const newItem = allItems[allItems.length - 1];
                newItem.querySelector('.column-selector').value = sort.column;
                newItem.querySelector('.direction-selector').value = sort.direction;
            });
        }

        if (query.action && query.action.type === 'email') {
            document.getElementById('email-notification-checkbox').checked = true;
            document.getElementById('email-recipient').value = query.action.recipient || '';
            document.getElementById('email-cc').value = query.action.cc || '';
            toggleEmailInputs();
        } else {
            document.getElementById('email-notification-checkbox').checked = false;
            toggleEmailInputs();
        }

        updateQueryJson();
    }

    function openSaveToLibraryModal() {
        document.getElementById('save-modal').style.display = 'flex';
    }

    function closeSaveModal() {
        document.getElementById('save-modal').style.display = 'none';
    }

    function openScheduleModal() {
        document.getElementById('schedule-modal').style.display = 'flex';
    }

    function closeScheduleModal() {
        document.getElementById('schedule-modal').style.display = 'none';
    }

    function toggleScheduleInputs() {
        const scheduleType = document.getElementById('schedule-type-selector').value;
        document.getElementById('one-time-schedule-inputs').style.display = scheduleType === 'one-time' ? 'block' : 'none';
        document.getElementById('recurring-schedule-inputs').style.display = scheduleType === 'recurring' ? 'block' : 'none';
    }

    function submitSchedule() {
        const scheduleType = document.getElementById('schedule-type-selector').value;
        const jsonString = document.getElementById('query-formula-json').value;

        try {
            const query = JSON.parse(jsonString);
            if (scheduleType === 'one-time') {
                const scheduleTime = new Date(document.getElementById('schedule-datetime').value);
                const now = new Date();
                if (isNaN(scheduleTime.getTime()) || scheduleTime <= now) {
                    alert("Please select a valid future date and time.");
                    return;
                }
                google.script.run
                    .withSuccessHandler(response => {
                        alert(response);
                        closeScheduleModal();
                    })
                    .withFailureHandler(handleError)
                    .scheduleQuery(query, scheduleTime.toISOString());
            } else { // recurring
                const cronString = document.getElementById('schedule-cron').value;
                if (!cronString) { // Basic validation
                    alert("Please enter a valid cron string for the recurring schedule.");
                    return;
                }
                google.script.run
                    .withSuccessHandler(response => {
                        alert(response);
                        closeScheduleModal();
                    })
                    .withFailureHandler(handleError)
                    .scheduleRecurringQuery(query, cronString);
            }
        } catch (e) {
            alert("Could not schedule query. Please check the query formula.");
        }
    }

    function saveToLibrary() {
        const name = document.getElementById('save-query-name').value;
        const description = document.getElementById('save-query-description').value;
        const queryJson = document.getElementById('query-formula-json').value;

        if (!name) {
            alert("Please provide a name for the query.");
            return;
        }

        google.script.run
            .withSuccessHandler(response => {
                alert(response);
                closeSaveModal();
                // Refresh the library dropdown
                google.script.run.withSuccessHandler(populateQueryLibrary).withFailureHandler(handleError).getQueriesFromLibrary();
            })
            .withFailureHandler(handleError)
            .saveQueryToLibrary(name, description, queryJson);
    }

    function runQuery() {
      const jsonString = document.getElementById('query-formula-json').value;
      try {
        // We still parse to validate, but we will send the raw string
        const queryForValidation = JSON.parse(jsonString);
        if (!queryForValidation.from || queryForValidation.from.length === 0) {
          alert("Please select at least one sheet in the 'FROM' clause.");
          return;
        }

        const runButton = event.target;
        runButton.disabled = true;
        runButton.textContent = "Submitting...";

        google.script.run
            .withSuccessHandler(response => {
                const message = `${response.message || 'Query submitted successfully.'} Your results will appear in the sheet linked below as soon as processing is complete.`;
                const link = response.outputUrl ? `<a href="${response.outputUrl}" target="_blank">Click here to view the results sheet.</a>` : "";

                const notification = document.createElement('div');
                notification.innerHTML = `${message}<br>${link}`;
                notification.style.cssText = "position:fixed; top:20px; right:20px; background-color: #007B5F; color:white; padding:15px; border-radius:8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); z-index:1001;";
                document.body.appendChild(notification);

                setTimeout(() => {
                    notification.remove();
                }, 15000);

                runButton.disabled = false;
                runButton.textContent = "Run Query";
            })
            .withFailureHandler(error => {
                handleError(error);
                runButton.disabled = false;
                runButton.textContent = "Run Query";
            })
            .submitQueryToQueue(jsonString); // <-- CRITICAL FIX: Pass the raw string, not the parsed object

      } catch (e) {
        alert("Error parsing the query JSON. Please check the formula.\n" + e.message);
        const runButton = document.querySelector('.btn-primary');
        if(runButton) {
          runButton.disabled = false;
          runButton.textContent = "Run Query";
        }
      }
    }
  </script>

</body>
</html>
