<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <title>Advanced Query Assistant</title>
    <!-- External Libraries -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Fira+Code&display=swap" rel="stylesheet">
    <!-- Main Styles -->
    <style>
        :root {
            --primary-bg: #F8F9FA;
            --secondary-bg: #FFFFFF;
            --primary-accent: #0D47A1;
            --secondary-accent: #1976D2;
            --text-dark: #212529;
            --text-light: #6C757D;
            --border-color: #DEE2E6;
            --success-green: #28A745;
            --danger-red: #DC3545;
        }
        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--primary-bg);
            color: var(--text-dark);
            margin: 0;
            padding: 24px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: var(--secondary-bg);
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.08);
            overflow: hidden;
        }
        .wizard-header {
            display: flex;
            justify-content: space-around;
            background-color: var(--primary-accent);
            padding: 20px 0;
            color: white;
        }
        .step-indicator {
            display: flex;
            align-items: center;
            opacity: 0.5;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        .step-indicator.active {
            opacity: 1;
        }
        .step-indicator .step-icon {
            font-size: 24px;
            margin-right: 12px;
        }
        .wizard-content {
            padding: 30px;
        }
        .step-panel {
            display: none;
        }
        .step-panel.active {
            display: block;
        }
        .panel-header {
            font-size: 26px;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--primary-accent);
        }
        .selection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 15px;
        }
        .selection-grid label {
            background: #F1F3F5;
            padding: 12px;
            border-radius: 8px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .selection-grid label:hover {
            background: #E9ECEF;
        }
        .selection-grid input:checked + span {
            font-weight: 700;
            color: var(--secondary-accent);
        }
        .selection-grid input:checked + label {
            border-color: var(--secondary-accent);
        }
        #where-clause-builder {
          background-color: #F8F9FA;
          border: 1px solid var(--border-color);
          padding: 20px;
          border-radius: 8px;
        }
        .filter-group {
            background-color: var(--secondary-bg);
            border: 1px dashed var(--border-color);
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 6px;
        }
        .group-controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        .filter-rule, .aggregation-rule {
            display: grid;
            grid-template-columns: 1.2fr 1fr 1.2fr auto;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }
        .btn {
            padding: 10px 18px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        .btn-primary { background-color: var(--secondary-accent); color: white; }
        .btn-secondary { background-color: #6C757D; color: white; }
        .btn-danger { background-color: var(--danger-red); color: white; }
        .btn-success { background-color: var(--success-green); color: white; }
        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }
        #live-preview {
            background-color: #212529;
            color: #F8F9FA;
            font-family: 'Fira Code', monospace;
            padding: 20px;
            border-radius: 8px;
            margin-top: 25px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        #live-preview .sql-keyword { color: #569CD6; }
        #live-preview .sql-function { color: #DCDCAA; }
        #live-preview .sql-string { color: #CE9178; }
        .sort-item {
          display: grid;
          grid-template-columns: 1fr 1fr auto;
          gap: 10px;
          align-items: center;
          margin-bottom: 10px;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="wizard-header">
        <div id="step-indicator-1" class="step-indicator active">
            <i class="fas fa-file-alt step-icon"></i>
            <div>Step 1: Select Sheets</div>
        </div>
        <div id="step-indicator-2" class="step-indicator">
            <i class="fas fa-columns step-icon"></i>
            <div>Step 2: Define Columns</div>
        </div>
        <div id="step-indicator-3" class="step-indicator">
            <i class="fas fa-filter step-icon"></i>
            <div>Step 3: Build Conditions</div>
        </div>
        <div id="step-indicator-4" class="step-indicator">
            <i class="fas fa-sort-amount-down step-icon"></i>
            <div>Step 4: Review & Run</div>
        </div>
    </div>

    <div class="wizard-content">
        <!-- Step 1: Select Sheets (FROM) -->
        <div id="step-panel-1" class="step-panel active">
            <div class="panel-header">Select Data Sheets</div>
            <p>Choose one or more sheets to query from. The data will be combined (UNION).</p>
            <div id="from-sheets-list" class="selection-grid">
                <!-- Sheet checkboxes will be here -->
            </div>
            <div id="load-query-container" style="margin-top: 20px;">
                <label for="query-library-selector">Load a saved query:</label>
                <select id="query-library-selector">
                    <option value="">Select a query...</option>
                </select>
                <button class="btn btn-secondary" onclick="loadQueryFromLibrary()">Load</button>
            </div>
            <div class="navigation-buttons">
                <button class="btn btn-secondary" disabled>Previous</button>
                <button class="btn btn-primary" onclick="goToStep(2)">Next</button>
            </div>
        </div>

        <!-- Step 2: Select Columns (SELECT, GROUP BY) -->
        <div id="step-panel-2" class="step-panel">
            <div class="panel-header">Define Output Columns</div>
            <p>Select the columns to include in your results. Use aggregations if you want to group data.</p>
            <div id="aggregation-mode-toggle">
                <label>
                    <input type="checkbox" onchange="toggleAggregationMode(this.checked)">
                    Use Aggregations (GROUP BY)
                </label>
            </div>
            <div id="columns-container">
                <div id="select-columns-list" class="selection-grid"></div>
                <div id="aggregation-builder" style="display:none;">
                    <h4>Group By</h4>
                    <div id="groupby-columns-list" class="selection-grid"></div>
                    <h4>Aggregations</h4>
                    <div id="aggregation-rules-container"></div>
                    <button class="btn btn-secondary" onclick="addAggregationRule()">+ Add Aggregation</button>
                </div>
            </div>
             <div class="navigation-buttons">
                <button class="btn btn-secondary" onclick="goToStep(1)">Previous</button>
                <button class="btn btn-primary" onclick="goToStep(3)">Next</button>
            </div>
        </div>

        <!-- Step 3: Where Clause -->
        <div id="step-panel-3" class="step-panel">
            <div class="panel-header">Build Conditions (WHERE)</div>
            <p>Create rules to filter your data. You can build nested conditions by adding groups.</p>
             <div id="where-clause-builder"></div>
            <div class="navigation-buttons">
                <button class="btn btn-secondary" onclick="goToStep(2)">Previous</button>
                <button class="btn btn-primary" onclick="goToStep(4)">Next</button>
            </div>
        </div>

        <!-- Step 4: Order By & Run -->
        <div id="step-panel-4" class="step-panel">
            <div class="panel-header">Review & Run Query</div>
            <p>Review the generated query below. You can add sorting rules before running.</p>
            <div id="order-by-builder"></div>
            <div id="actions-builder">
                <h4>Actions</h4>
                <label><input type="checkbox" id="email-notification-checkbox" onchange="toggleEmailInputs()"> Send Email Notification</label>
                <div id="email-inputs" style="display: none; margin-top: 10px;">
                    <input type="email" id="email-recipient" placeholder="Recipient Email (required)">
                    <input type="email" id="email-cc" placeholder="CC Emails (comma-separated, optional)" style="margin-top: 5px;">
                </div>
            </div>
            <div id="live-preview"></div>
            <div class="navigation-buttons">
                <button class="btn btn-secondary" onclick="goToStep(3)">Previous</button>
                <button class="btn btn-primary" onclick="saveQuery()">Save Query</button>
                <button class="btn btn-success" onclick="runQuery(event)">Run Query</button>
            </div>
        </div>
    </div>
</div>

<script>
    let currentStep = 1;
    let allSheetHeaders = {};
    let availableColumns = [];
    let queryLibrary = [];
    const query = {
        select: [],
        from: [],
        where: { logic: 'AND', groups: [] },
        groupBy: [],
        orderBy: [],
        action: {}
    };

    const operators = [
        { value: 'is', text: 'is' }, { value: 'is_not', text: 'is not' },
        { value: 'is_one_of', text: 'is one of (comma-separated)' }, { value: 'is_not_one_of', text: 'is not one of (comma-separated)' },
        { value: 'contains', text: 'contains' }, { value: 'does_not_contain', text: 'does not contain' },
        { value: 'starts_with', text: 'starts with' }, { value: 'does_not_start_with', text: 'does not start with' },
        { value: 'ends_with', text: 'ends with' }, { value: 'does_not_end_with', text: 'does not end with' },
        { value: 'is_greater_than', text: 'is >' }, { value: 'is_less_than', text: 'is <' },
        { value: 'is_greater_than_or_equal_to', text: 'is >=' }, { value: 'is_less_than_or_equal_to', text: 'is <=' },
        { value: 'is_blank', text: 'is blank' }, { value: 'is_not_blank', text: 'is not blank' },
        { value: 'matches_regex', text: 'matches regex' }, { value: 'does_not_match_regex', text: 'does not match regex' }
    ];

    window.addEventListener('load', () => {
        google.script.run.withSuccessHandler(sheets => {
            const container = document.getElementById('from-sheets-list');
            sheets.forEach(name => {
                container.innerHTML += `<label><input type="checkbox" name="sheetName" value="${name}" onchange="updateFromClause()"> <span>${name}</span></label>`;
            });
        }).getAllSheetNames();
        google.script.run.withSuccessHandler(queries => {
            queryLibrary = queries;
            const selector = document.getElementById('query-library-selector');
            queries.forEach((q, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = q.name;
                selector.appendChild(option);
            });
        }).getQueriesFromLibrary();
        initializeWhereBuilder();
        initializeOrderByBuilder();
        updateLivePreview();
    });

    function goToStep(step) {
        if (step === 2 && query.from.length === 0) {
            alert("Please select at least one sheet before proceeding.");
            return;
        }
        if (step > currentStep) {
            if (currentStep === 1) {
                fetchColumnsForSelectedSheets().then(() => {
                    populateSelectColumns();
                    populateGroupByColumns();
                    updateColumnSelectors();
                    proceed();
                });
            } else {
                proceed();
            }
        } else {
            proceed();
        }

        function proceed() {
            document.getElementById(`step-panel-${currentStep}`).classList.remove('active');
            document.getElementById(`step-indicator-${currentStep}`).classList.remove('active');
            currentStep = step;
            document.getElementById(`step-panel-${currentStep}`).classList.add('active');
            document.getElementById(`step-indicator-${currentStep}`).classList.add('active');
        }
    }

    function updateFromClause() {
        query.from = Array.from(document.querySelectorAll('[name="sheetName"]:checked')).map(cb => cb.value);
        updateLivePreview();
    }

    function fetchColumnsForSelectedSheets() {
        return new Promise(resolve => {
            const promises = query.from.map(sheetName => {
                if (!allSheetHeaders[sheetName]) {
                    return new Promise(res => google.script.run.withSuccessHandler(headers => {
                        allSheetHeaders[sheetName] = headers;
                        res();
                    }).getSheetHeaders(sheetName));
                }
                return Promise.resolve();
            });
            Promise.all(promises).then(() => {
                const columnSet = new Set();
                query.from.forEach(sheetName => {
                    (allSheetHeaders[sheetName] || []).forEach(col => columnSet.add(col));
                });
                availableColumns = Array.from(columnSet).sort();
                resolve();
            });
        });
    }

    function populateSelectColumns() {
        const container = document.getElementById('select-columns-list');
        container.innerHTML = availableColumns.map(col => `<label><input type="checkbox" name="selectColumn" value="${col}" onchange="updateSelectClause()"> <span>${col}</span></label>`).join('');
    }

    function populateGroupByColumns() {
        const container = document.getElementById('groupby-columns-list');
        container.innerHTML = availableColumns.map(col => `<label><input type="checkbox" name="groupByColumn" value="${col}" onchange="updateGroupByClause()"> <span>${col}</span></label>`).join('');
    }

    function toggleAggregationMode(isAggregationMode) {
        document.getElementById('select-columns-list').style.display = isAggregationMode ? 'none' : 'grid';
        document.getElementById('aggregation-builder').style.display = isAggregationMode ? 'block' : 'none';
        updateSelectClause();
    }

    function addAggregationRule() {
        const container = document.getElementById('aggregation-rules-container');
        const ruleId = `agg-rule-${Date.now()}`;
        const ruleEl = document.createElement('div');
        ruleEl.className = 'aggregation-rule';
        ruleEl.id = ruleId;

        const columnOptions = availableColumns.map(c => `<option value="${c}">${c}</option>`).join('');

        ruleEl.innerHTML = `
            <select class="aggregation-function-selector" onchange="updateSelectClause()">
                <option value="COUNT">COUNT</option>
                <option value="SUM">SUM</option>
                <option value="AVG">AVG</option>
            </select>
            <select class="column-selector" onchange="updateSelectClause()">${columnOptions}</select>
            <input type="text" placeholder="Alias (optional)" oninput="updateSelectClause()">
            <button class="btn btn-danger" onclick="this.parentElement.remove(); updateSelectClause();">&times;</button>
        `;
        container.appendChild(ruleEl);
        updateSelectClause();
    }

    function updateGroupByClause() {
        query.groupBy = Array.from(document.querySelectorAll('[name="groupByColumn"]:checked')).map(cb => cb.value);
        updateSelectClause();
    }

    function updateSelectClause() {
        const isAggregationMode = document.querySelector('#aggregation-mode-toggle input').checked;
        if (isAggregationMode) {
            query.select = [...query.groupBy];
            document.querySelectorAll('.aggregation-rule').forEach(rule => {
                const func = rule.querySelector('.aggregation-function-selector').value;
                const col = rule.querySelector('.column-selector').value;
                const alias = rule.querySelector('input').value;
                let select = `${func}(${col})`;
                if (alias) {
                    select += ` AS ${alias}`;
                }
                query.select.push(select);
            });
        } else {
            query.select = Array.from(document.querySelectorAll('[name="selectColumn"]:checked')).map(cb => cb.value);
            query.groupBy = [];
        }
        updateLivePreview();
    }

    function initializeWhereBuilder() {
        const container = document.getElementById('where-clause-builder');
        container.innerHTML = `
            <div class="group-controls">
                <span>Match</span>
                <select id="root-logic-selector" onchange="updateWhereClause()">
                    <option value="AND">ALL</option>
                    <option value="OR">ANY</option>
                </select>
                <span>of the following groups:</span>
                <button class="btn btn-primary" onclick="addGroup()">+ Add Group</button>
            </div>
            <div id="where-groups-container"></div>
        `;
        addGroup();
    }

    function addGroup() {
        const groupId = `group-${Date.now()}`;
        const groupEl = document.createElement('div');
        groupEl.className = 'filter-group';
        groupEl.id = groupId;
        groupEl.innerHTML = `
            <div class="group-controls">
                <span>Match</span>
                <select onchange="updateWhereClause()">
                    <option value="AND">ALL</option>
                    <option value="OR">ANY</option>
                </select>
                <span>of the following rules:</span>
                <button class="btn btn-danger" onclick="this.parentElement.parentElement.remove(); updateWhereClause();">&times;</button>
            </div>
            <div class="rules-container"></div>
            <button class="btn btn-secondary" onclick="addRule('${groupId}')">+ Add Rule</button>
        `;
        document.getElementById('where-groups-container').appendChild(groupEl);
        addRule(groupId);
    }

    function addRule(groupId) {
        const ruleId = `rule-${Date.now()}`;
        const ruleEl = document.createElement('div');
        ruleEl.className = 'filter-rule';
        ruleEl.id = ruleId;

        const columnOptions = availableColumns.map(c => `<option value="${c}">${c}</option>`).join('');
        const operatorOptions = operators.map(o => `<option value="${o.value}">${o.text}</option>`).join('');

        ruleEl.innerHTML = `
            <select class="column-selector" onchange="updateWhereClause()">${columnOptions}</select>
            <select class="operator-selector" onchange="updateWhereClause()">${operatorOptions}</select>
            <input type="text" placeholder="Value" oninput="updateWhereClause()">
            <button class="btn btn-danger" onclick="this.parentElement.remove(); updateWhereClause();">&times;</button>
        `;
        document.querySelector(`#${groupId} .rules-container`).appendChild(ruleEl);
        updateWhereClause();
    }

    function updateColumnSelectors() {
        const columnOptions = availableColumns.map(c => `<option value="${c}">${c}</option>`).join('');
        document.querySelectorAll('.column-selector').forEach(sel => {
            const currentValue = sel.value;
            sel.innerHTML = columnOptions;
            if (availableColumns.includes(currentValue)) {
                sel.value = currentValue;
            }
        });
    }

    function updateWhereClause() {
        query.where.logic = document.getElementById('root-logic-selector').value;
        query.where.groups = [];
        document.querySelectorAll('#where-groups-container .filter-group').forEach(groupEl => {
            const group = {
                logic: groupEl.querySelector('select').value,
                rules: []
            };
            groupEl.querySelectorAll('.filter-rule').forEach(ruleEl => {
                group.rules.push({
                    column: ruleEl.querySelector('.column-selector').value,
                    operator: ruleEl.querySelector('.operator-selector').value,
                    value: ruleEl.querySelector('input').value
                });
            });
            if (group.rules.length > 0) {
                query.where.groups.push(group);
            }
        });
        updateLivePreview();
    }

    function initializeOrderByBuilder() {
        const container = document.getElementById('order-by-builder');
        container.innerHTML = `
            <h4>Sorting (ORDER BY)</h4>
            <div id="orderby-container"></div>
            <button class="btn btn-secondary" onclick="addSortItem()">+ Add Sorting Rule</button>
        `;
    }

    function addSortItem() {
        const sortId = `sort-${Date.now()}`;
        const sortEl = document.createElement('div');
        sortEl.className = 'sort-item';
        sortEl.id = sortId;

        const columnOptions = availableColumns.map(c => `<option value="${c}">${c}</option>`).join('');

        sortEl.innerHTML = `
            <select class="column-selector" onchange="updateOrderByClause()">${columnOptions}</select>
            <select class="direction-selector" onchange="updateOrderByClause()">
                <option value="ASC">Ascending</option>
                <option value="DESC">Descending</option>
            </select>
            <button class="btn btn-danger" onclick="this.parentElement.remove(); updateOrderByClause();">&times;</button>
        `;
        document.getElementById('orderby-container').appendChild(sortEl);
        updateOrderByClause();
    }

    function updateOrderByClause() {
        query.orderBy = [];
        document.querySelectorAll('.sort-item').forEach(item => {
            query.orderBy.push({
                column: item.querySelector('.column-selector').value,
                direction: item.querySelector('.direction-selector').value
            });
        });
        updateLivePreview();
    }

    function toggleEmailInputs() {
        const isChecked = document.getElementById('email-notification-checkbox').checked;
        document.getElementById('email-inputs').style.display = isChecked ? 'block' : 'none';
        updateAction();
    }

    function updateAction() {
        const isChecked = document.getElementById('email-notification-checkbox').checked;
        if (isChecked) {
            query.action = {
                type: 'email',
                recipient: document.getElementById('email-recipient').value,
                cc: document.getElementById('email-cc').value
            };
        } else {
            query.action = {};
        }
    }

    function saveQuery() {
        const name = prompt("Enter a name for your query:");
        if (name) {
            google.script.run
                .withSuccessHandler(() => alert("Query saved successfully!"))
                .withFailureHandler(err => alert(`Error saving query: ${err.message}`))
                .saveQueryToLibrary(name, "", JSON.stringify(query));
        }
    }

    function loadQueryFromLibrary() {
        const selector = document.getElementById('query-library-selector');
        const selectedIndex = selector.value;
        if (selectedIndex !== "" && queryLibrary[selectedIndex]) {
            const loadedQuery = JSON.parse(queryLibrary[selectedIndex].queryJson);
            rebuildUiFromQuery(loadedQuery);
        }
    }

    async function rebuildUiFromQuery(loadedQuery) {
        // Resetting UI to default state
        document.querySelectorAll('[name="sheetName"]').forEach(cb => cb.checked = false);
        document.getElementById('select-columns-list').innerHTML = '';
        document.getElementById('where-groups-container').innerHTML = '';
        document.getElementById('orderby-container').innerHTML = '';

        // FROM
        loadedQuery.from.forEach(sheetName => {
            const cb = document.querySelector(`[name="sheetName"][value="${sheetName}"]`);
            if (cb) cb.checked = true;
        });
        query.from = loadedQuery.from;

        await fetchColumnsForSelectedSheets();

        // SELECT & GROUP BY
        const isAggregationMode = loadedQuery.groupBy && loadedQuery.groupBy.length > 0;
        document.querySelector('#aggregation-mode-toggle input').checked = isAggregationMode;
        toggleAggregationMode(isAggregationMode);

        if (isAggregationMode) {
            populateGroupByColumns();
            loadedQuery.groupBy.forEach(col => {
                const cb = document.querySelector(`[name="groupByColumn"][value="${col}"]`);
                if (cb) cb.checked = true;
            });

            const aggRulesContainer = document.getElementById('aggregation-rules-container');
            aggRulesContainer.innerHTML = '';
            const aggFunctions = loadedQuery.select.filter(s => !loadedQuery.groupBy.includes(s));
            aggFunctions.forEach(func => {
                 addAggregationRule();
                 const newRule = aggRulesContainer.lastElementChild;
                 const match = func.match(/(\w+)\((.*?)\)(?: AS (\w+))?/);
                 if(match) {
                    newRule.querySelector('.aggregation-function-selector').value = match[1];
                    newRule.querySelector('.column-selector').value = match[2];
                    if(match[3]) newRule.querySelector('input').value = match[3];
                 }
            });
        } else {
            populateSelectColumns();
            loadedQuery.select.forEach(col => {
                const cb = document.querySelector(`[name="selectColumn"][value="${col}"]`);
                if (cb) cb.checked = true;
            });
        }

        // WHERE
        document.getElementById('where-groups-container').innerHTML = '';
        if (loadedQuery.where && loadedQuery.where.groups) {
            document.getElementById('root-logic-selector').value = loadedQuery.where.logic;
            loadedQuery.where.groups.forEach(groupData => {
                addGroup();
                const newGroup = document.getElementById('where-groups-container').lastElementChild;
                newGroup.querySelector('select').value = groupData.logic;
                const rulesContainer = newGroup.querySelector('.rules-container');
                rulesContainer.innerHTML = '';
                groupData.rules.forEach(ruleData => {
                    addRule(newGroup.id);
                    const newRule = rulesContainer.lastElementChild;
                    newRule.querySelector('.column-selector').value = ruleData.column;
                    newRule.querySelector('.operator-selector').value = ruleData.operator;
                    newRule.querySelector('input').value = ruleData.value;
                });
            });
        }

        // ORDER BY
        if (loadedQuery.orderBy) {
            loadedQuery.orderBy.forEach(sort => {
                addSortItem();
                const newItem = document.getElementById('orderby-container').lastElementChild;
                newItem.querySelector('.column-selector').value = sort.column;
                newItem.querySelector('.direction-selector').value = sort.direction;
            });
        }

        updateSelectClause();
    }


    function updateLivePreview() {
        let html = `<div><span class="sql-keyword">SELECT</span> ${query.select.length > 0 ? query.select.join(', ') : '*'}</div>`;
        html += `<div><span class="sql-keyword">FROM</span> ${query.from.length > 0 ? query.from.join(', ') : '...'}</div>`;

        if (query.where.groups.length > 0) {
            html += `<div><span class="sql-keyword">WHERE</span> ${formatWhereClause(query.where)}</div>`;
        }

        if (query.groupBy.length > 0) {
            html += `<div><span class="sql-keyword">GROUP BY</span> ${query.groupBy.join(', ')}</div>`;
        }

        if (query.orderBy.length > 0) {
            const orderClauses = query.orderBy.map(o => `${o.column} <span class="sql-keyword">${o.direction}</span>`);
            html += `<div><span class="sql-keyword">ORDER BY</span> ${orderClauses.join(', ')}</div>`;
        }

        document.getElementById('live-preview').innerHTML = html;
    }

    function formatWhereClause(where) {
        if (!where || !where.groups || where.groups.length === 0) return '';
        const groupClauses = where.groups.map(group => {
            const ruleClauses = group.rules.map(rule => {
                return `${rule.column} <span class="sql-function">${rule.operator.replace(/_/g, ' ')}</span> <span class="sql-string">'${rule.value}'</span>`;
            }).join(` <span class="sql-keyword">${group.logic}</span> `);
            return `( ${ruleClauses} )`;
        });
        return groupClauses.join(` <span class="sql-keyword">${where.logic}</span> `);
    }

     function runQuery(event) {
        if (query.from.length === 0) {
            alert("Your query is not runnable. Please select a sheet in Step 1.");
            return;
        }
        if (query.select.length === 0) {
            query.select = availableColumns;
        }
        updateAction();

        const runButton = event.target;
        runButton.disabled = true;
        runButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';

        google.script.run
            .withSuccessHandler(response => {
                alert("Query submitted successfully! You will receive an email with a link to the results shortly.");
                runButton.disabled = false;
                runButton.innerHTML = 'Run Query';

            })
            .withFailureHandler(error => {
                alert(`An error occurred: ${error.message}`);
                runButton.disabled = false;
                runButton.innerHTML = 'Run Query';
            })
            .submitQueryToQueue(JSON.stringify(query));
    }
</script>
</body>
</html>
