
<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <title>Manager Email Hub</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <style>
    :root {
      --background-main: #F0F8F5;
      --primary-accent: #00B14F;
      --card-background: #FFFFFF;
      --text-primary: #111827;
      --text-secondary: #6B7280;
      --border-light: #E5E7EB;
    }
    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--background-main);
      color: var(--text-primary);
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 1200px;
      margin: auto;
    }
    .card {
      background-color: var(--card-background);
      border: 1px solid var(--border-light);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }
    h1 {
      color: var(--primary-accent);
      font-weight: 800;
      font-size: 2em;
    }
    h2 {
      font-size: 1.2em;
      font-weight: 700;
      margin-top: 0;
    }
    .grid-container {
      display: grid;
      grid-template-columns: 1fr 2fr;
      gap: 20px;
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      font-weight: 600;
      margin-bottom: 5px;
    }
    input[type="text"], textarea, select {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid var(--border-light);
      background-color: #F9FAFB;
      box-sizing: border-box;
    }
    button {
      background-color: var(--primary-accent);
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }
    #live-preview {
      min-height: 400px;
      border: 2px dashed var(--border-light);
      padding: 15px;
      border-radius: 8px;
    }
    .draggable-block {
      background-color: #F9FAFB;
      padding: 10px;
      border: 1px solid var(--border-light);
      border-radius: 8px;
      margin-bottom: 10px;
      cursor: grab;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Manager Email Hub</h1>

    <div class="card">
      <h2>Template Selector</h2>
      <div class="form-group">
        <label for="template-select">Choose a Template</label>
        <select id="template-select"></select>
      </div>
    </div>

    <div class="grid-container">
      <div id="configuration-column" class="card">
        <!-- Content will be dynamically loaded here -->
      </div>
      <div id="live-preview-column" class="card">
        <h2>Live Preview</h2>
        <div id="live-preview">
          <!-- Preview will be dynamically loaded here -->
        </div>
      </div>
    </div>
  </div>

  <div id="log-modal" style="display:none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
    <div style="background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 600px; border-radius: 12px;">
      <h2 id="log-modal-title">Email Sending Status</h2>
      <div id="log-modal-content" style="max-height: 300px; overflow-y: auto;"></div>
      <button id="close-log-modal" style="margin-top: 15px;">Close</button>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const templateSelect = document.getElementById('template-select');
      const configurationColumn = document.getElementById('configuration-column');
      const livePreview = document.getElementById('live-preview');
      let recipients = { agents: [], managers: [] };
      let emailTemplates = [];
      let dashboardSections = [];

      function init() {
        google.script.run.withSuccessHandler(data => {
          recipients = data;
        }).getEmailRecipients();

        google.script.run.withSuccessHandler(data => {
          dashboardSections = data;
        }).getDashboardSections();

        google.script.run.withSuccessHandler(templates => {
          emailTemplates = templates;
          populateTemplateSelector();
          handleTemplateChange();
        }).getEmailTextTemplates();

        templateSelect.addEventListener('change', handleTemplateChange);
      }

      function handleTemplateChange() {
        const selectedId = templateSelect.value;
        const selectedTemplate = emailTemplates.find(t => t.id === selectedId);

        if (!selectedTemplate) return;

        if (selectedTemplate.isCustom === 'TRUE' || selectedTemplate.id === 'custom-new') {
          setupCustomEmail(selectedTemplate);
        } else {
          setupMonthlyPerformance();
        }
      }

      function setupMonthlyPerformance() {
        configurationColumn.innerHTML = `
          <h2>Configuration</h2>
          <div class="form-group">
            <label for="subject">Subject</label>
            <input type="text" id="subject" value="Your Monthly Performance Report">
          </div>
          <div class="form-group">
            <label for="managers-note">Manager's Note</label>
            <textarea id="managers-note" rows="5"></textarea>
          </div>
          <div class="form-group">
            <label for="recipients">Recipients</label>
            <select id="recipients" multiple></select>
          </div>
          <button id="send-monthly">Send Emails</button>
        `;

        livePreview.innerHTML = `<p><i>Live preview for monthly performance email is generated individually for each recipient upon sending.</i></p>`;
        populateRecipients();

        document.getElementById('send-monthly').addEventListener('click', () => {
          const recipientList = Array.from(document.getElementById('recipients').selectedOptions).map(option => ({ email: option.value, name: option.text.split('(')[0].trim() }));
          const subject = document.getElementById('subject').value;
          const managersNote = document.getElementById('managers-note').value;

          if (recipientList.length === 0) {
            alert('Please select at least one recipient.');
            return;
          }
          showSendLogModal('Sending monthly performance emails...', true);
          google.script.run
            .withSuccessHandler(displaySendLog)
            .withFailureHandler(err => displaySendLog({ error: err.message }))
            .sendMonthlyPerformanceEmail(recipientList, subject, managersNote);
        });
      }

      function setupCustomEmail(template) {
        configurationColumn.innerHTML = `
          <h2>Configuration</h2>
          <div class="form-group">
            <label for="custom-subject">Subject</label>
            <input type="text" id="custom-subject" value="${template.subject || 'Custom Email'}">
          </div>
          <div class="form-group">
            <label>Draggable Blocks</label>
            <div id="draggable-blocks" style="padding: 10px; border: 1px solid #eee; border-radius: 8px;"></div>
          </div>
          <div class="form-group">
            <label for="recipients">Recipients</label>
            <select id="recipients" multiple></select>
          </div>
          <button id="send-custom">Send Email</button>
          <button id="save-template" style="background-color: #6B7280; margin-left: 10px;">Save as Template</button>
        `;

        livePreview.innerHTML = template.body || '';

        const draggableBlocks = document.getElementById('draggable-blocks');
        dashboardSections.forEach(section => {
          const block = document.createElement('div');
          block.className = 'draggable-block';
          block.textContent = section;
          draggableBlocks.appendChild(block);
        });

        new Sortable(draggableBlocks, {
          group: { name: 'shared', pull: 'clone', put: false },
          sort: false,
          animation: 150
        });

        new Sortable(livePreview, {
          group: 'shared',
          animation: 150,
          onAdd: function (evt) {
            const blockName = evt.item.textContent;
            evt.item.innerHTML = '<div>Loading...</div>';
            const selectedRecipient = document.getElementById('recipients').value;
            google.script.run
              .withSuccessHandler(html => { evt.item.innerHTML = html; })
              .getCustomEmailBlockHtml(blockName, selectedRecipient);
          }
        });

        populateRecipients();

        document.getElementById('save-template').addEventListener('click', () => {
          const templateName = prompt("Enter a name for this template:");
          if (templateName) {
            const templateHtml = livePreview.innerHTML;
            google.script.run.withSuccessHandler(response => {
              if (response.success) {
                alert(response.message);
                google.script.run.withSuccessHandler(templates => {
                  emailTemplates = templates;
                  populateTemplateSelector();
                  templateSelect.value = response.newId;
                }).getEmailTextTemplates();
              } else {
                alert('Error: ' + response.error);
              }
            }).saveCustomEmailTemplate(templateName, templateHtml);
          }
        });

        document.getElementById('send-custom').addEventListener('click', () => {
          const recipientList = Array.from(document.getElementById('recipients').selectedOptions).map(option => ({ email: option.value, name: option.text.split('(')[0].trim() }));
          const subject = document.getElementById('custom-subject').value;
          const emailBodyHtml = livePreview.innerHTML;

          if (recipientList.length === 0) {
            alert('Please select at least one recipient.');
            return;
          }
          showSendLogModal('Sending custom email...', true);
          google.script.run
            .withSuccessHandler(displaySendLog)
            .withFailureHandler(err => displaySendLog({ error: err.message }))
            .sendCustomEmail(recipientList, subject, emailBodyHtml);
        });
      }

      function populateTemplateSelector() {
        templateSelect.innerHTML = '';
        const monthly = emailTemplates.find(t => t.id === 'monthly-performance');
        if (monthly) {
          const option = document.createElement('option');
          option.value = monthly.id;
          option.textContent = monthly.subject;
          templateSelect.appendChild(option);
        }

        const customTemplates = emailTemplates.filter(t => t.isCustom === 'TRUE');
        if (customTemplates.length > 0) {
          const group = document.createElement('optgroup');
          group.label = "Custom Templates";
          customTemplates.forEach(t => {
            const option = document.createElement('option');
            option.value = t.id;
            option.textContent = t.subject;
            group.appendChild(option);
          });
          templateSelect.appendChild(group);
        }

        const newCustomOption = document.createElement('option');
        newCustomOption.value = 'custom-new';
        newCustomOption.textContent = 'âœ¨ New Custom Email';
        templateSelect.appendChild(newCustomOption);
      }

      function populateRecipients() {
        const select = document.getElementById('recipients');
        if (!select) return;
        select.innerHTML = '';

        const agentGroup = document.createElement('optgroup');
        agentGroup.label = "Agents";
        recipients.agents.forEach(agent => {
            const option = document.createElement('option');
            option.value = agent.email;
            option.textContent = `${agent.name} (${agent.email})`;
            agentGroup.appendChild(option);
        });
        select.appendChild(agentGroup);

        const managerGroup = document.createElement('optgroup');
        managerGroup.label = "Managers";
         recipients.managers.forEach(manager => {
            const option = document.createElement('option');
            option.value = manager.email;
            option.textContent = `${manager.name} (${manager.email})`;
            managerGroup.appendChild(option);
        });
        select.appendChild(managerGroup);
      }

      function showSendLogModal(message, showLoader) {
        const modal = document.getElementById('log-modal');
        const content = document.getElementById('log-modal-content');
        content.innerHTML = '';
        if (showLoader) {
          content.innerHTML = `<p>${message} <span class="loader"></span></p>`;
        } else {
          content.innerHTML = `<p>${message}</p>`;
        }
        modal.style.display = 'block';
      }

      function displaySendLog(log) {
        const content = document.getElementById('log-modal-content');
        let html = '';
        if (log.error) {
          html = `<p style="color: red;"><strong>Error:</strong> ${log.error}</p>`;
        } else {
          html += `<h3>Summary</h3><p>${log.success.length} sent, ${log.failed.length} failed.</p>`;
          if (log.success.length > 0) {
            html += '<h4>Successful:</h4><ul>' + log.success.map(e => `<li>${e}</li>`).join('') + '</ul>';
          }
          if (log.failed.length > 0) {
            html += '<h4>Failed:</h4><ul>' + log.failed.map(f => `<li>${f.email}: <span style="color:red;">${f.error}</span></li>`).join('') + '</ul>';
          }
        }
        content.innerHTML = html;
      }

      document.getElementById('close-log-modal').addEventListener('click', () => {
        document.getElementById('log-modal').style.display = 'none';
      });

      init();
    });
  </script>
</body>
</html>
